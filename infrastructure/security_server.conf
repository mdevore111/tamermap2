# ────────────────────────────────────────────────────────────
# security_server.conf – per-vhost security snippet
# Include this inside each `server { … }` block
# ────────────────────────────────────────────────────────────

# 1) Deny hidden, backup and system files
location ~ /\.(?!well-known) {
    deny all;
}
location ~ ~\$ {
    deny all;
}

# 2) Block dangerous file extensions
location ~* \.(?:php[345]?|phtml|pl|py|jsp|asp|sh|cgi)$ {
    return 444;
}

# 3) Block wrapper/stream attacks
location ~* (?:php://|data://|file://|ftp://|https?://) {
    return 444;
}

# 4) Block path-traversal attempts (encoded & plain)
if ($request_uri  ~* "(?:\.\./|\.\.\\|%2e%2e|%252e|%00|/etc/passwd)") {
    return 444;
}

# 5) Block SQL- and code-injection patterns
if ($request_uri  ~* "(?:union.*select|select.+from|drop.+table|eval\(|base64_decode|exec\()") {
    return 444;
}
if ($query_string ~* "(?:union.*select|select.+from|drop.+table|eval\(|base64_decode|exec\()") {
    return 444;
}

# 6) Block PHP-info & template-injection attempts
if ($request_uri  ~* "(?:phpinfo\(\)|\{\$\s*phpinfo\(\))") {
    return 444;
}
if ($query_string ~* "(?:phpinfo\(\)|\{\$\s*phpinfo\(\))") {
    return 444;
}

# 7) Block suspicious User-Agent strings (DISABLED - Cloudflare handles this)
# if ($http_user_agent ~* "(?:bot|crawler|spider|scanner|sqlmap|nikto|nmap|masscan|dirb|gobuster)") {
#     return 444;
# }

# 8) Block suspicious Referer headers
if ($http_referer  ~* "(?:phpinfo|eval|base64|system)") {
    return 444;
}

# 9) Block suspicious query parameters
if ($args ~* "(?:phpinfo|eval|base64|system|exec|shell)") {
    return 444;
}

# 10) Rate limiting (DISABLED - Cloudflare handles this better)
#    – "general" zone for all normal endpoints
# limit_req zone=general burst=50 nodelay;

# Admin-only rate limiting + proxy (no auth for production)
location /admin/ {
    # limit_req      zone=admin burst=20 nodelay;  # DISABLED - Cloudflare handles this
    client_max_body_size 5m;

    proxy_http_version    1.1;
    proxy_set_header      Connection        "";
    proxy_set_header      Host              $host;
    proxy_set_header      X-Real-IP         $remote_addr;
    proxy_set_header      X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header      Accept-Encoding   "";
    proxy_hide_header     Content-Encoding;
    proxy_buffering       off;

    proxy_pass       http://127.0.0.1:8000;
}
