# ────────────────────────────────────────────────────────────
# Main Nginx Configuration
# ────────────────────────────────────────────────────────────

user www-data;
worker_processes auto;
worker_cpu_affinity auto;
pid /run/nginx.pid;

# Global error log (debug for in-depth troubleshooting)
error_log /var/log/nginx/error.log debug;

# Load dynamic modules
include /etc/nginx/modules-enabled/*.conf;


# ────────────────────────────────────────────────────────────
# Events
# ────────────────────────────────────────────────────────────
events {
    worker_connections 768;
    # multi_accept on;        # Uncomment to accept many connections at once
}


# ────────────────────────────────────────────────────────────
# HTTP Server Configuration
# ────────────────────────────────────────────────────────────
http {

include /etc/nginx/includes/cloudflare_realip.conf;

    # real_ip_header CF-Connecting-IP;
    # real_ip_recursive on;

    ## Basic Settings ##
    sendfile             on;
    tcp_nopush           on;
    types_hash_max_size  2048;
    server_tokens        off;    # Hide Nginx version

    # MIME types
    include              /etc/nginx/mime.types;
    default_type         application/octet-stream;

    ## SSL Settings ##
    ssl_protocols        TLSv1.2 TLSv1.3;    # Disable SSLv3/TLS1.0/1.1
    ssl_prefer_server_ciphers off;           # Don't force cipher order

    ## Logging ##
    access_log           /var/log/nginx/access.log;

    ## Global Security ##
    # Apply high-level HTTP protections (injections, header checks, etc.)
    include              /etc/nginx/snippets/security_http.conf;

    ## Proxy Settings ##
    proxy_headers_hash_max_size   1024;
    proxy_headers_hash_bucket_size 128;

    ## Gzip Compression ##
    gzip                 on;
    # gzip_vary          on;
    # gzip_proxied       any;
    # gzip_buffers       16 8k;
    # gzip_http_version  1.1;
    # gzip_types         text/plain text/css application/json application/javascript text/xml application/xml+rss text/javascript;

    ## Virtual Hosts ##
    include              /etc/nginx/conf.d/*.conf;
    include              /etc/nginx/sites-enabled/*;
}


# ────────────────────────────────────────────────────────────
# Mail Proxy (disabled by default)
# ────────────────────────────────────────────────────────────
# mail {
#    # Example POP3/IMAP proxy setup
#    server {
#        listen   localhost:110;
#        protocol pop3;
#        proxy    on;
#    }
#    server {
#        listen   localhost:143;
#        protocol imap;
#        proxy    on;
#    }
# }

