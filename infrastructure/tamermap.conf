# ────────────────────────────────────────────────────────────
# Unified Tamermap Nginx Configuration
# Environment: PRODUCTION
# Generated on 2025-09-10 18:00:00
# ────────────────────────────────────────────────────────────

# ────────────────────────────────────────────────────────────
# Cloudflare IP Protection
# ────────────────────────────────────────────────────────────

# Define Cloudflare IP ranges
geo $cloudflare_ip {
    default 0;

    # Cloudflare IPv4 ranges
    173.245.48.0/20 1;
    103.21.244.0/22 1;
    103.22.200.0/22 1;
    103.31.4.0/22 1;
    141.101.64.0/18 1;
    108.162.192.0/18 1;
    190.93.240.0/20 1;
    188.114.96.0/20 1;
    197.234.240.0/22 1;
    198.41.128.0/17 1;
    162.158.0.0/15 1;
    104.16.0.0/13 1;
    104.24.0.0/14 1;
    172.64.0.0/13 1;
    131.0.72.0/22 1;

    # Cloudflare IPv6 ranges
    2400:cb00::/32 1;
    2606:4700::/32 1;
    2803:f800::/32 1;
    2405:b500::/32 1;
    2405:8100::/32 1;
    2a06:98c0::/29 1;
    2c0f:f248::/32 1;
}

# Allow your workstation IP
geo $your_ip {
    default 0;
    # Your IP will be added here by the emergency script
}

# Allow workstation domain (permanent solution)
geo $workstation_domain {
    default 0;
    # This will be populated by the server script that checks workstation.tamermap.com
}

# Allow monitoring traffic by user agent
map $http_user_agent $is_monitor {
    default 0;
    ~*Tamermap-Monitor 1;
}

# HTTP → HTTPS redirect
server {
    listen 80;
    server_name tamermap.com www.tamermap.com;
    return 301 https://$host$request_uri;
}

# HTTPS server block
server {
    listen 443 ssl;
    http2 on;
    server_name tamermap.com www.tamermap.com;

    # SSL certificates
    ssl_certificate     /etc/ssl/cloudflare/staging_origin.pem;
    ssl_certificate_key /etc/ssl/cloudflare/staging_origin.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # ────────────────────────────────────────────────────────────
    # Basic Security (minimal - Cloudflare handles the rest)
    # ────────────────────────────────────────────────────────────

    # Deny hidden files
    location ~ /\.(?!well-known) {
        deny all;
    }

    # Block dangerous file extensions
    location ~* \.(?:php[345]?|phtml|pl|py|jsp|asp|sh|cgi)$ {
        return 444;
    }

    # Block suspicious referer headers
    if ($http_referer ~* "(?:phpinfo|eval|base64|system)") {
        return 444;
    }

    # Block suspicious query parameters
    if ($args ~* "(?:phpinfo|eval|base64|system|exec|shell)") {
        return 444;
    }

    # ── Health check endpoint
    location = /healthz {
        add_header Content-Type text/plain;
        return 200 'ok';
    }

    # ── Static assets
    location /static/ {
        alias /home/tamermap/app/static/;
        access_log off;
        expires 7d;
    }

    # ── Stripe webhooks
    location /webhooks/stripe {
        client_max_body_size 10m;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_pass         http://127.0.0.1:8000;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto https;
        proxy_set_header   CF-Connecting-IP  $http_cf_connecting_ip;
    }

    # ── API endpoints
    location /api/ {
        client_max_body_size 10m;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_pass         http://127.0.0.1:8000;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto https;
        proxy_set_header   CF-Connecting-IP  $http_cf_connecting_ip;
    }

    # ── Admin panel
    location /admin/ {
        client_max_body_size 5m;

        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_pass         http://127.0.0.1:8000;

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto https;
        proxy_set_header   CF-Connecting-IP  $http_cf_connecting_ip;
    }

    # ── Main application
    location / {
        # Check if request is from Cloudflare, your IP, or workstation domain
        if ($cloudflare_ip = 0) {
            set $block_access 1;
        }
        if ($your_ip = 1) {
            set $block_access 0;
        }
        if ($workstation_domain = 1) {
            set $block_access 0;
        }
        if ($block_access = 1) {
            return 403 "Access denied. Please use the official website.";
        }

        proxy_http_version 1.1;
        proxy_set_header   Connection "";

        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto https;
        proxy_set_header   CF-Connecting-IP  $http_cf_connecting_ip;

        proxy_pass         http://127.0.0.1:8000;
    }
}
