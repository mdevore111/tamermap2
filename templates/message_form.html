{# message_form.html #}
{% extends "base.html" %}

{% block title %}Contact TamerMap - Send Message, Report Issues, or Get Support{% endblock %}

{% block meta_description %}Contact TamerMap for support, report store issues, suggest improvements, or get help with Pokemon card hunting. Our customer support team is here to help you succeed.{% endblock %}
{% block content %}
<div class="page-content">
  {% if message_sent %}
    <div class="form-container">
      <h1>Message Sent!</h1>
      <div class="text-center mt-3">
        <a href="/" class="btn btn-link">Back to Map</a>
      </div>
    </div>
    <script>
      setTimeout(function() {
        window.location.href = '/';
      }, 5000);
    </script>
  {% else %}
    <div class="form-container">
      {% set comm_label = dict(form.communication_type.choices)
                          .get(form.communication_type.data, "Let's Connect") %}
      <h1>{{ comm_label }}</h1>
      <p>Use the form below to tell us more, and our customer support team will help you find your answers.</p>

      <form method="POST" action="{{ request.path }}">
        {{ form.hidden_tag() }}

      {# always hide the type dropdown, drive via link #}
      <input type="hidden" name="communication_type" value="{{ form.communication_type.data }}">
      
      {# Spam prevention fields #}
      {{ form.honeypot(class="honeypot-field") }}
      {{ form.timestamp(value=request.args.get('ts', '')) }}
      {{ form.website(class="honeypot-field") }}
      {{ form.phone(class="honeypot-field") }}
      
      <script>
        // Add timestamp to form for spam prevention
        document.addEventListener('DOMContentLoaded', function() {
          var timestampField = document.querySelector('input[name="timestamp"]');
          if (timestampField) {
            timestampField.value = Date.now();
          }
          
          // Add random delay to prevent instant submissions
          var submitButton = document.querySelector('input[type="submit"]');
          if (submitButton) {
            submitButton.addEventListener('click', function(e) {
              var currentTime = Date.now();
              var timestamp = parseInt(timestampField.value);
              if (currentTime - timestamp < 2000) { // Less than 2 seconds
                e.preventDefault();
                alert('Please wait a moment before submitting the form.');
                return false;
              }
            });
          }

          // Dynamic label update for location type
          var locationCheckbox = document.querySelector('#is_new_location');
          var locationBodyLabel = document.querySelector('#location-body-label');
          
          if (locationCheckbox && locationBodyLabel) {
            locationCheckbox.addEventListener('change', function() {
              if (this.checked) {
                locationBodyLabel.textContent = 'Describe the NEW location details, what Pokemon cards they carry, and any other relevant information:';
              } else {
                locationBodyLabel.textContent = 'Describe the incorrect information and provide the correct details below:';
              }
            });
          }
        });
      </script>

      {# New: Name and Address fields for all types #}
      <div class="mb-3">
        {{ form.name.label(class="form-label") }}
        {{ form.name(class="form-control") }}
      </div>
      <div class="mb-3">
        {{ form.address.label(class="form-label") }}
        {{ form.address(class="form-control") }}
      </div>

      {# only for report: hide subject field and pass original address #}
      {% if form.communication_type.data == 'report' %}
        <input type="hidden" name="subject" value="{{ form.subject.data }}">
      {% endif %}

      {# visible subject for non-report types #}
      {% if form.communication_type.data != 'report' %}
        <div class="mb-3">
          {{ form.subject.label(class="form-label") }}
          {{ form.subject(class="form-control") }}
        </div>
      {% endif %}

      {# Location-specific checkboxes for location type #}
      {% if form.communication_type.data == 'location' %}
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="is_new_location" name="is_new_location" value="1">
            <label class="form-check-label" for="is_new_location">
              <strong>This is a NEW location</strong> (not reporting incorrect information about an existing location)
            </label>
          </div>
          <div class="form-text text-muted">
            Check this box if you're adding a completely new Pokemon card location. Leave unchecked if you're reporting incorrect information about an existing location.
          </div>
        </div>
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="is_admin_report" name="is_admin_report" value="1">
            <label class="form-check-label" for="is_admin_report">
              <strong>This is for Admin review</strong> (not updating/correcting a location)
            </label>
          </div>
          <div class="form-text text-muted">
            Check this box if you're submitting this for admin review rather than updating or correcting location information.
          </div>
        </div>
      {% endif %}

      {# body field with dynamic label #}
      <div class="mb-3">
        {% if form.communication_type.data == 'report' %}
          <label for="{{ form.body.id }}" class="form-label">
            Describe Your Changes Here and Correct Data Below:
          </label>
        {% elif form.communication_type.data == 'location' %}
          <label for="{{ form.body.id }}" class="form-label">
            <span id="location-body-label">Describe the location details, what Pokemon cards they carry, and any other relevant information:</span>
          </label>
        {% else %}
          {{ form.body.label(class="form-label") }}
        {% endif %}
        {{ form.body(class="form-control", rows=8) }}
      </div>

      {# Out of business checkbox for report type #}
      {% if form.communication_type.data == 'report' %}
        <div class="mb-3">
          <div class="form-check">
            {{ form.out_of_business(class="form-check-input") }}
            <label class="form-check-label" for="{{ form.out_of_business.id }}">
              {{ form.out_of_business.label.text }}
            </label>
          </div>
        </div>
      {% endif %}

        {# extra report metadata #}
        {% if form.communication_type.data == 'report' %}
          <div class="mb-3">
            {{ form.reported_address.label(class="form-label") }}
            {{ form.reported_address(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.reported_phone.label(class="form-label") }}
            {{ form.reported_phone(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.reported_website.label(class="form-label") }}
            {{ form.reported_website(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.reported_hours.label(class="form-label") }}
            {{ form.reported_hours(class="form-control") }}
          </div>
        {% endif %}

        {# Support-specific fields #}
        {% if form.communication_type.data == 'support' %}
          <div class="mb-3">
            {{ form.support_topic.label(class="form-label") }}
            {{ form.support_topic(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ form.order_number.label(class="form-label") }}
            {{ form.order_number(class="form-control") }}
          </div>
        {% endif %}

        {# Business-specific fields #}
        {% if form.communication_type.data == 'business' %}
          <div class="mb-3">
            {{ form.company_name.label(class="form-label") }}
            {{ form.company_name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.company_website.label(class="form-label") }}
            {{ form.company_website(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ form.company_size.label(class="form-label") }}
            {{ form.company_size(class="form-select") }}
          </div>
        {% endif %}

        {# Post Wins specific fields #}
        {% if form.communication_type.data == 'post_wins' %}
          <div class="mb-3">
            {{ form.win_type.label(class="form-label") }}
            {{ form.win_type(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ form.location_used.label(class="form-label") }}
            {{ form.location_used(class="form-control") }}
            <div class="form-text">Which TamerMap locations did you use?</div>
          </div>
          <div class="mb-3">
            {{ form.cards_found.label(class="form-label") }}
            {{ form.cards_found(class="form-control") }}
            <div class="form-text">What cards did you find? (e.g., "Charizard VMAX, Pikachu V")</div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                {{ form.time_saved.label(class="form-label") }}
                {{ form.time_saved(class="form-control") }}
                <div class="form-text">How much time did you save?</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                {{ form.money_saved.label(class="form-label") }}
                {{ form.money_saved(class="form-control") }}
                <div class="form-text">How much money did you save?</div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              {{ form.allow_feature(class="form-check-input") }}
              <label class="form-check-label" for="{{ form.allow_feature.id }}">
                {{ form.allow_feature.label.text }}
              </label>
            </div>
            <div class="form-text">We may feature your win on our User Wins page (with your permission)</div>
          </div>
        {% endif %}

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
          <a href="{{ url_for('public.home') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
          {{ form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  {% endif %}
</div>

<style>
.honeypot-field {
  display: none !important;
  position: absolute;
  left: -9999px;
}

/* Ensure consistent button alignment */
.d-grid .btn {
  vertical-align: middle;
  height: 38px; /* Match Bootstrap button height */
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
</style>
{% endblock %}
