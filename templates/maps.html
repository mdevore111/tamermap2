{% extends "base.html" %}

{% block body_class %} map-page{% endblock %}

{% block title %}
Find Pokemon Cards Near Me - Interactive Map of Kiosks & Card Shops | TamerMap
{% endblock %}

{% block meta_description %}
Find Pokemon cards near you with our interactive map! Discover Pokemon card kiosks, retail stores, and indie shops nationwide. Plan your card hunting routes, locate fresh inventory, and find rare Pokemon cards. Use our route planner to maximize your Pokemon card hunting success.
{% endblock %}

{% block extra_head %}
  <!-- Load map-specific CSS styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/maps.css') }}">
  
  <!-- Schema.org LocalBusiness markup for Pokemon card hunting -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Find Pokemon Cards Near Me - Interactive Map",
    "description": "Interactive map for finding Pokemon cards at kiosks, retail stores, and indie shops nationwide. Plan your card hunting routes and discover fresh Pokemon card inventory.",
    "url": "{{ request.url }}",
    "mainEntity": {
      "@type": "ItemList",
      "name": "Pokemon Card Locations",
      "description": "Comprehensive list of Pokemon card kiosks, retail stores, and specialty shops across the United States",
      "numberOfItems": "1000+",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "item": {
            "@type": "LocalBusiness",
            "name": "Pokemon Card Kiosks",
            "description": "Find Pokemon card vending machines and kiosks with fresh inventory",
            "category": "Pokemon Card Retail",
            "serviceType": "Pokemon Card Sales"
          }
        },
        {
          "@type": "ListItem",
          "position": 2,
          "item": {
            "@type": "LocalBusiness",
            "name": "Pokemon Card Shops",
            "description": "Specialty stores and card shops with Pokemon TCG inventory",
            "category": "Trading Card Games",
            "serviceType": "Pokemon Card Sales"
          }
        }
      ]
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ request.url_root.rstrip('/') }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Pokemon Card Map",
          "item": "{{ request.url }}"
        }
      ]
    }
  }
  </script>
{% endblock %}

{% block content %}
  <div class="map-container">
    {% include 'components/map.html' %}
    {% include 'components/legend.html' %}
    {% include 'components/search.html' %}
  </div>

  <!-- Pro Features -->
  {# {% if is_pro %}
    <div class="pro-features">
      <div class="pro-banner">
        <i class="fas fa-crown"></i> Pro Features Active
      </div>
    </div>
  {% endif %} #}

  <!-- Admin Features -->
  {# {% if is_admin %}
    <div class="admin-features">
      <div class="admin-banner">
        <i class="fas fa-shield-alt"></i> Admin Mode Active
      </div>
    </div>
  {% endif %} #}
{% endblock %}

{% block extra_scripts %}
<!-- Initialize global variables -->
<script>
  // Set is_pro based on the context processor value for frontend use
  window.is_pro = {{ is_pro|tojson }};
  window.userRole = "{{ current_user.is_authenticated and current_user.roles[0].name or 'User' }}";
  window.retailersEndpoint = "{{ url_for('api.retailers_endpoint') }}";
  
  // Define initApp function immediately to ensure it's available for Google Maps API
  window.initApp = function() {
    console.log('[maps.html] window.initApp called');
    // This will be called by Google Maps API
    // The actual implementation will be loaded by the module
    if (window.initAppImpl) {
      console.log('[maps.html] initAppImpl present, invoking');
      window.initAppImpl();
    } else {
      console.warn('[maps.html] initAppImpl not loaded yet, retrying...');
      setTimeout(() => {
        if (window.initAppImpl) {
          console.log('[maps.html] initAppImpl now present, invoking');
          window.initAppImpl();
        } else {
          console.error('[maps.html] initAppImpl failed to load');
        }
      }, 100);
    }
  };
</script>

<!-- Load our modules first (static include to avoid race with Google callback) -->
<script>
  console.log('[maps.html] about to load map-init.js module');
  window.__TM_DEBUG__ = true;
  window.tmDiag = [];
  window.tmLog = function(msg, data) { try { window.tmDiag.push({ t: Date.now(), msg, data }); } catch(e) {} console.log(msg, data||''); };
  // Static include ensures initAppImpl is available before Google callback runs
</script>
<script type="module" src="{{ url_for('static', filename='js/map-init-v2.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/routePlanner.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/cacheManager.js') }}"></script>

<!-- Load Google Maps API with callback -->
<script
  src="https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&libraries=visualization,places,geometry&callback=initApp"
  defer>
</script>

<!-- Add pinch-to-zoom control -->
<script>
  // Progressive Enhancement: Only add touch-specific features if the browser supports them.
  if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
    document.addEventListener('touchmove', function(event) {
      if (event.touches.length > 1) {
        const mapElement = document.getElementById('map');
        const isTouchOnMap = Array.from(event.touches).some(touch =>
          mapElement.contains(document.elementFromPoint(touch.clientX, touch.clientY))
        );
        if (!isTouchOnMap) {
          event.preventDefault();
        }
      }
    }, { passive: false });
  }
</script>

{% if not is_pro %}
  <script>
         document.addEventListener('DOMContentLoaded', function() {
       if (typeof Swal !== 'undefined') {
         const lastPopupTime = localStorage.getItem('lastPopupTime');
         const now = Date.now();
         const oneHour = 60 * 60 * 1000;

         if (!lastPopupTime || now - parseInt(lastPopupTime) > oneHour) {
           localStorage.setItem('lastPopupTime', now.toString());
           
           Swal.fire({
             title: 'Find more even faster with Pro',
             imageUrl: "{{ url_for('static', filename='images/pro-compare.png') }}",
             imageAlt: 'Retail shops map',
             imageWidth: '100%',
             imageHeight: 'auto',
             showCancelButton: true,
             confirmButtonText: 'Upgrade Now',
             cancelButtonText: 'Maybe Later',
             allowOutsideClick: true,
             allowEscapeKey: true,
             allowEnterKey: true,
             stopKeydownPropagation: false,
             heightAuto: false,
                           width: window.innerWidth <= 768 ? '95%' : '480px',
             customClass: {
               popup: 'swal2-upgrade-modal'
             }
           }).then((result) => {
             if (result.isConfirmed) {
               window.location.href = "{{ url_for('public.learn') }}";
             }
           });
         }
       }
     });
  </script>
{% endif %}
{% endblock %}
