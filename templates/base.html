<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="{% block meta_description %}TamerMap - Your interactive map for finding Pokémon cards at kiosks, retail stores, and indie shops nationwide. Plan your card hunting routes and discover events.{% endblock %}">
  <title>{% block title %}TAMERMAP.COM{% endblock %}</title>
  <link rel="canonical" href="{{ request.url }}">
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@tamermap">
  <meta name="twitter:title" content="{{ self.title() }}">
  <meta name="twitter:description" content="{{ self.meta_description() }}">
  <meta name="twitter:image" content="{% block twitter_image %}{{ url_for('static', filename='logo.png', _external=True) }}{% endblock %}">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:site_name" content="TamerMap">
  <meta property="og:type" content="{% block og_type %}website{% endblock %}">
  <meta property="og:title" content="{{ self.title() }}">
  <meta property="og:description" content="{{ self.meta_description() }}">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:image" content="{% block og_image %}{{ url_for('static', filename='logo.png', _external=True) }}{% endblock %}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  
  <!-- JSON-LD Structured Data -->
  <script type="application/ld+json">
  {{
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "TamerMap",
      "url": request.url_root.rstrip('/'),
      "description": "Interactive map for finding Pokémon cards at kiosks, retail stores, and indie shops nationwide",
      "potentialAction": {
        "@type": "SearchAction",
        "target": request.url_root.rstrip('/') + "/maps",
        "query-input": "required name=location"
      }
    } | tojson
  }}
  </script>
  
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- SweetAlert2 CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Password Strength Meter CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/password-strength.css') }}">
  {% block extra_head %}{% endblock %}
  <style>
    /* Custom dropdown styling */
    .navbar .dropdown-menu {
      background: white;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 0.5rem;
      margin-top: 0.5rem;
    }

    .navbar .dropdown-item {
      color: #555;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .navbar .dropdown-item:hover {
      background: #f8f9fa;
      color: #007bff;
    }

    .navbar .dropdown-item i {
      color: #007bff;
      width: 20px;
      text-align: center;
    }

    .navbar .dropdown-toggle::after {
      display: none;
    }

    .navbar .fa-chevron-down {
      font-size: 0.8rem;
      transition: transform 0.2s ease;
    }

    .navbar .show .fa-chevron-down {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="d-flex flex-column{% block body_class %}{% endblock %}">
  <header>
    <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #007bff;">
      <div class="container-fluid">
        <!-- Logo -->
        <a class="navbar-brand text-white" href="{{ url_for('public.splash') }}">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Tamermap Logo" style="height:40px;">
        </a>
        <!-- Hamburger Toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarMenu" aria-controls="navbarMenu"
                aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <!-- Collapsible Menu Items -->
        <div class="collapse navbar-collapse" id="navbarMenu">
          <ul class="navbar-nav ms-auto">
      <li class="nav-item">
        <a class="nav-link text-white" href="{{ url_for('public.user_wins') }}">User Wins</a>
      </li>
                  <li class="nav-item">
        <a class="nav-link text-white" href="{{ url_for('public.how_to') }}">Hunting Guides</a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" href="{{ url_for('public.site_tutorials') }}">Help & Tutorials</a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" href="{{ url_for('public.faq') }}">FAQ</a>
      </li>
            <li class="nav-item dropdown">
              <a class="nav-link text-white dropdown-toggle" href="#" id="contactDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Contact <i class="fas fa-chevron-down ms-1"></i>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="contactDropdown">
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.send_message', type='contact') }}">
                    <i class="fas fa-question-circle me-2"></i> General Contact
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.send_message', type='suggestion') }}">
                    <i class="fas fa-lightbulb me-2"></i> Suggestions
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.add_location') }}">
                    <i class="fas fa-plus-circle me-2"></i> Add New Location
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.send_message', type='support') }}">
                    <i class="fas fa-life-ring me-2"></i> Customer Support
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.send_message', type='business') }}">
                    <i class="fas fa-briefcase me-2"></i> Business Inquiry
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('public.send_message', type='post_wins') }}">
                    <i class="fas fa-trophy me-2"></i> Post Wins
                  </a>
                </li>
              </ul>
            </li>
            {% if current_user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link text-white" href="{{ url_for('auth.account') }}">Account</a>
              </li>
              {% if is_admin %}
                <li class="nav-item">
                  <a class="nav-link text-white" href="{{ url_for('admin.index') }}">Admin</a>
                </li>
              {% endif %}
              <li class="nav-item">
                <a class="nav-link text-white" href="{{ url_for('security.logout') }}">Logout</a>
              </li>
            {% else %}
              <li class="nav-item">
                <a class="nav-link text-white" href="{{ url_for('security.login') }}">Login</a>
              </li>
                           <li class="nav-item">
               <a class="btn btn-try-pro" href="{{ url_for('public.learn') }}">Try Pro</a>
             </li>
           {% endif %}
         </ul>
       </div>
     </div>
   </nav>
 </header>

  <main id="main-content" class="flex-grow-1">
    {% block content %}{% endblock %}
  </main>

  <footer id="footer" class="py-1" style="background-color: #007bff;">
    <div class="container-fluid">
      <div class="row align-items-center justify-content-between">
        <!-- Left Side: Company Info -->
        <div class="col-auto text-start text-white">
          © 2025 Tamermap.com
        </div>
        <!-- Right Side: Site Info & Legal Links -->
                 <div class="col-auto text-end text-white">
           <a class="text-white" href="{{ url_for('public.about') }}">About</a>

           | <a class="text-white" href="{{ url_for('public.privacy') }}">Privacy</a>
           | <a class="text-white" href="{{ url_for('public.terms') }}">Terms</a>
           | <a class="text-white" href="{{ url_for('public.sitemap') }}">Sitemap</a>
         </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <!-- Disable CSP programmatically -->
  <script>
    // Remove any existing CSP meta tags
    document.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(meta => meta.remove());
    
    // Create a new permissive CSP meta tag
    const cspMeta = document.createElement('meta');
    cspMeta.setAttribute('http-equiv', 'Content-Security-Policy');
    cspMeta.setAttribute('content', "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' data: blob:;");
    document.head.appendChild(cspMeta);
  </script>

  <!-- Pass flash messages as a global variable -->
  <script>
    var flashMessages = {{ get_flashed_messages(with_categories=true) | tojson }};
    // Pass user role information to JavaScript
    var is_pro = {{ is_pro|tojson }};
    var is_admin = {{ is_admin|tojson }};
  </script>

  <!-- Initialize Bootstrap tooltips and auto-hide after 3 seconds -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        const tooltip = new bootstrap.Tooltip(tooltipTriggerEl);

        // Hide the tooltip after 2 seconds when it's shown.
        tooltipTriggerEl.addEventListener('shown.bs.tooltip', function () {
          setTimeout(() => {
            tooltip.hide();
          }, 2000);
        });
      });
    });
  </script>

<!-- Persist checkbox states using LocalStorage, conditional on pro status -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Check if the user is logged in
    const isLoggedIn = {{ current_user.is_authenticated|tojson }};
    
    // First check if user is logged in AND is a pro user
    if (isLoggedIn && is_pro) {
      // Logged-in Pro users: process all checkboxes and remember their state
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach((checkbox) => {
        // Form a unique key based on the checkbox ID.
        const key = "checkbox_" + checkbox.id;
        // Retrieve the stored state from LocalStorage, if available.
        const storedValue = localStorage.getItem(key);
        if (storedValue !== null) {
          checkbox.checked = storedValue === "true";
        }
        // Update LocalStorage when this checkbox changes.
        checkbox.addEventListener("change", function () {
          localStorage.setItem(key, checkbox.checked);
        });
      });
    } else if (isLoggedIn) {
      // Logged-in Non-pro users: only process the kiosk checkbox
      const kiosk = document.getElementById("filter-kiosk");
      if (kiosk) {
        const key = "checkbox_filter-kiosk";
        const storedValue = localStorage.getItem(key);
        if (storedValue !== null) {
          kiosk.checked = storedValue === "true";
        }
        kiosk.addEventListener("change", function () {
          localStorage.setItem(key, kiosk.checked);
        });
      }
    } else {
      // Non-logged-in users (regardless of potential Pro status): 
      // Force kiosk checkbox to be checked and all others unchecked,
      // ignoring localStorage for initial state
      const kiosk = document.getElementById("filter-kiosk");
      if (kiosk) {
        // Always set kiosk to checked, regardless of localStorage
        kiosk.checked = true;
        
        // Still save changes to localStorage if the user changes it
        kiosk.addEventListener("change", function () {
          localStorage.setItem("checkbox_filter-kiosk", kiosk.checked);
        });
      }
      
      // Make sure non-kiosk checkboxes are unchecked
      const otherCheckboxes = document.querySelectorAll("input[type='checkbox']:not(#filter-kiosk)");
      otherCheckboxes.forEach((checkbox) => {
        checkbox.checked = false;
        
        // Still allow them to be changed and saved
        checkbox.addEventListener("change", function () {
          localStorage.setItem("checkbox_" + checkbox.id, checkbox.checked);
        });
      });
    }
  });
</script>

  {% block extra_scripts %}
    <!-- External flash messages script -->
    <script src="{{ url_for('static', filename='js/flash_messages.js') }}"></script>
    <!-- Password Strength Meter JavaScript -->
    <script src="{{ url_for('static', filename='js/password-strength.js') }}"></script>
  {% endblock %}
</body>
</html>
