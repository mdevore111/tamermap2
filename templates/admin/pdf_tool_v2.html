{% extends "admin/base.html" %}

{% block head_css %}
{{ super() }}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>PDF Tool</h2>
    </div>

    <form id="pdfForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-lg-8">
                <div id="dropZone" style="border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; background-color: #f8f9fa; transition: all 0.3s ease; margin-bottom: 20px; cursor: pointer;">
                    <div id="dropContent">
                        <div style="font-size: 48px; color: #6c757d; margin-bottom: 15px;">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4>Drop your PDF file here</h4>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" style="display: none;">
                    </div>
                </div>

                <div id="pdfPreviewArea" style="display: none; margin-top: 20px; background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6; font-weight: 600; color: #495057;">
                        <i class="fas fa-file-pdf me-2"></i>PDF Preview
                    </div>
                    
                    <div style="display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                        <button type="button" class="btn btn-outline-secondary" id="prevPage" style="padding: .375rem .75rem; font-size: .875rem; min-width: auto; flex-shrink: 0;">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span style="font-size: .875rem; color: #6c757d; margin: 0 15px;">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </span>
                        <button type="button" class="btn btn-outline-secondary" id="nextPage" style="padding: .375rem .75rem; font-size: .875rem; min-width: auto; flex-shrink: 0;">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                                         <div id="pdfPreviewWrapper" style="position: relative; background: #fff; height: 600px; display: flex; align-items: center; justify-content: center; padding: 20px; border: 3px solid #dc3545;">
                         <div id="pdfPreview" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border: 2px dashed #007bff;"></div>
                     </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                    <h5 class="mb-3">Options</h5>
                    <div class="form-check disabled" id="compressOption" style="opacity: .5; pointer-events: none;">
                        <input class="form-check-input" type="checkbox" id="compress" name="compress">
                        <label class="form-check-label" for="compress" style="cursor: not-allowed;">
                            Compress PDF
                        </label>
                    </div>
                                         <div class="form-check disabled" id="signatureOption" style="opacity: .5; pointer-events: none;">
                         <input class="form-check-input" type="checkbox" id="addSignature" name="add_signature" unchecked>
                         <label class="form-check-label" for="addSignature" style="cursor: not-allowed;">
                             Add Signature
                         </label>
                     </div>

                    <div id="compressionStats" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 15px; border-radius: 8px; margin-top: 15px; display: none;">
                        <h6>Compression Results</h6>
                        <div id="compressionDetails"></div>
                    </div>

                    <div id="signatureSection" style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-top: 15px; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h5>Signature Options</h5>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Signature Type</div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="signatureType" id="drawnSignature" value="drawn" checked>
                                <label class="form-check-label" for="drawnSignature">Draw Signature</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="signatureType" id="typedSignature" value="typed">
                                <label class="form-check-label" for="typedSignature">Type Signature</label>
                            </div>
                        </div>
                        
                        <div id="drawnSignatureSection" style="text-align: center; margin-bottom: 20px;">
                            <h6>Draw your signature</h6>
                            <canvas id="signatureCanvas" width="300" height="150" style="border: 2px solid #dee2e6; border-radius: 8px; cursor: crosshair; background: white;"></canvas>
                            
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button type="button" id="clearSignature" style="padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; background: #dc3545; color: #fff;">Clear</button>
                                <button type="button" id="undoSignature" style="padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; background: #ffc107; color: #212529;">Undo</button>
                            </div>
                        </div>

                        <div id="typedSignatureSection" style="margin-bottom: 20px; display: none;">
                            <h6>Type your name</h6>
                            
                            <select id="fontSelect" class="form-control mb-3" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                                <option value="Dancing Script">Dancing Script</option>
                                <option value="Great Vibes">Great Vibes</option>
                                <option value="Pacifico">Pacifico</option>
                                <option value="Satisfy">Satisfy</option>
                                <option value="Kaushan Script">Kaushan Script</option>
                                <option value="Allura">Allura</option>
                            </select>
                            
                            <input type="text" id="typeSignature" class="form-control" placeholder="Type your name here..." style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                            
                            <div id="signaturePreview" style="margin-top: 15px; padding: 15px; background: #fff; border: 1px solid #dee2e6; border-radius: 4px; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                                <span class="text-muted">Signature preview will appear here</span>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <div style="font-size: 14px; color: #6c757d; margin-bottom: 5px;">Signature Size</div>
                            <input type="range" id="signatureSize" style="width: 100%; margin: 10px 0;" min="0.5" max="2" step="0.1" value="1">
                            <small class="text-muted">Scale: <span id="sizeValue">1.0</span>x</small>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button type="button" id="addSignatureBox" style="width: 100%; padding: 10px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                <i class="fas fa-plus"></i> Add Signature Box
                            </button>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="processBtn" disabled style="width: 100%; padding: 15px; font-size: 16px; font-weight: 600; border-radius: 8px; margin-top: 20px;">
                        <i class="fas fa-cog"></i> Process PDF
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Global variables
let isDrawing = false;
let signatureData = [];
let signatureHistory = [];
let currentPath = [];
let typeSignatureData = { text: '', font: 'Dancing Script' };
let canvas, ctx;
let currentPage = 1;
let totalPages = 1;
let pdfDocument = null;
let signatureOverlays = [];
let selectedFile = null;
let signatureBoxCounter = 0;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeCanvas();
    setupEventListeners();
    setupFontSelection();
    
    // Restore state from session storage
    restoreStateFromSession();
});

function initializeCanvas() {
    canvas = document.getElementById('signatureCanvas');
    ctx = canvas.getContext('2d');
    
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    setupCanvasEvents();
}

function setupCanvasEvents() {
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseout', handleMouseUp);
    
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
}

function handleMouseDown(e) {
    e.preventDefault();
    e.stopPropagation();
    startDrawing(e.offsetX, e.offsetY);
}

function handleMouseMove(e) {
    e.preventDefault();
    e.stopPropagation();
    if (isDrawing) {
        draw(e.offsetX, e.offsetY);
    }
}

function handleMouseUp(e) {
    e.preventDefault();
    e.stopPropagation();
    stopDrawing();
}

function handleTouchStart(e) {
    e.preventDefault();
    e.stopPropagation();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
}

function handleTouchMove(e) {
    e.preventDefault();
    e.stopPropagation();
    if (isDrawing) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        draw(touch.clientX - rect.left, touch.clientY - rect.top);
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    e.stopPropagation();
    stopDrawing();
}

function startDrawing(x, y) {
    isDrawing = true;
    currentPath = [{ x, y }];
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function draw(x, y) {
    if (!isDrawing) return;
    currentPath.push({ x, y });
    ctx.lineTo(x, y);
    ctx.stroke();
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        if (currentPath.length > 0) {
            signatureData.push([...currentPath]);
            signatureHistory.push([...currentPath]);
            updateAllSignatureOverlays();
            saveStateToSession();
        }
    }
}

function setupEventListeners() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('pdfFile');
    const form = document.getElementById('pdfForm');
    const addSignatureCheckbox = document.getElementById('addSignature');
    const signatureSection = document.getElementById('signatureSection');
    const clearBtn = document.getElementById('clearSignature');
    const undoBtn = document.getElementById('undoSignature');
    const typeSignatureInput = document.getElementById('typeSignature');
    const signatureSize = document.getElementById('signatureSize');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');

    // File upload
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#007bff';
        dropZone.style.background = '#e3f2fd';
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#f8f9fa';
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#ccc';
        dropZone.style.background = '#f8f9fa';
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
    
    // Compress checkbox
    document.getElementById('compress').addEventListener('change', saveStateToSession);

    // Signature controls
    addSignatureCheckbox.addEventListener('change', () => {
        signatureSection.style.display = addSignatureCheckbox.checked ? 'block' : 'none';
        if (addSignatureCheckbox.checked) {
            createSignatureOverlay();
        } else {
            clearAllSignatureOverlays();
        }
        saveStateToSession();
    });
    
    // Signature type selection
    document.getElementById('drawnSignature').addEventListener('change', function() {
        console.log('Switching to drawn signature');
        document.getElementById('drawnSignatureSection').style.display = 'block';
        document.getElementById('typedSignatureSection').style.display = 'none';
        updateAllSignatureOverlays();
        saveStateToSession();
    });
    
    document.getElementById('typedSignature').addEventListener('change', function() {
        console.log('Switching to typed signature');
        document.getElementById('drawnSignatureSection').style.display = 'none';
        document.getElementById('typedSignatureSection').style.display = 'block';
        updateAllSignatureOverlays();
        saveStateToSession();
    });
    
    // Also add click handlers as backup
    document.getElementById('drawnSignature').addEventListener('click', function() {
        console.log('Clicked drawn signature radio');
        setTimeout(() => {
            updateAllSignatureOverlays();
            saveStateToSession();
        }, 100);
    });
    
    document.getElementById('typedSignature').addEventListener('click', function() {
        console.log('Clicked typed signature radio');
        setTimeout(() => {
            updateAllSignatureOverlays();
            saveStateToSession();
        }, 100);
    });
    
    // Add signature box button
    document.getElementById('addSignatureBox').addEventListener('click', () => {
        createSignatureOverlay();
        saveStateToSession();
    });

    clearBtn.addEventListener('click', () => {
        clearCanvas();
        saveStateToSession();
    });
    undoBtn.addEventListener('click', () => {
        undoSignature();
        saveStateToSession();
    });
    typeSignatureInput.addEventListener('input', () => {
        updateTypeSignature();
        saveStateToSession();
    });
    signatureSize.addEventListener('input', () => {
        updateSignatureSize();
        saveStateToSession();
    });
    prevPage.addEventListener('click', () => {
        changePage(-1);
        saveStateToSession();
    });
    nextPage.addEventListener('click', () => {
        changePage(1);
        saveStateToSession();
    });

    // Form submission
    form.addEventListener('submit', processForm);
}

function setupFontSelection() {
    const fontSelect = document.getElementById('fontSelect');
    fontSelect.addEventListener('change', () => {
        typeSignatureData.font = fontSelect.value;
        updateTypeSignature();
        updateAllSignatureOverlays();
        saveStateToSession();
    });
}

function handleFileSelect(file) {
    if (file.type !== 'application/pdf') {
        showMessage('Please select a PDF file.', 'error');
        return;
    }

    selectedFile = file;
    
    const dropZone = document.getElementById('dropZone');
    const dropContent = document.getElementById('dropContent');
    const processBtn = document.getElementById('processBtn');
    
    dropZone.style.borderColor = '#28a745';
    dropZone.style.background = '#d4edda';
    dropContent.innerHTML = `
        <div style="font-size: 48px; color: #6c757d; margin-bottom: 15px;">
            <i class="fas fa-file-pdf text-success"></i>
        </div>
        <h5>${file.name}</h5>
        <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">${formatFileSize(file.size)}</div>
    `;
    
    document.getElementById('compressOption').style.opacity = '1';
    document.getElementById('compressOption').style.pointerEvents = 'auto';
    document.getElementById('signatureOption').style.opacity = '1';
    document.getElementById('signatureOption').style.pointerEvents = 'auto';
    processBtn.disabled = false;
    
    loadPdfPreview(file);
    saveStateToSession();
}

function loadPdfPreview(file) {
    const pdfPreviewArea = document.getElementById('pdfPreviewArea');
    const dropZone = document.getElementById('dropZone');
    
    dropZone.style.display = 'none';
    pdfPreviewArea.style.display = 'block';
    
    // Check if PDF.js is loaded
    if (typeof pdfjsLib === 'undefined') {
        showMessage('PDF.js library not loaded. Please refresh the page.', 'error');
        return;
    }
    
    const fileReader = new FileReader();
    fileReader.onload = function() {
        const typedarray = new Uint8Array(this.result);
        
        pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            pdfDocument = pdf;
            totalPages = pdf.numPages;
            currentPage = 1;
            
            updatePageNavigation();
            renderPage(1);
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            showMessage('Error loading PDF preview.', 'error');
        });
    };
    fileReader.readAsArrayBuffer(file);
}

function renderPage(pageNum) {
    if (!pdfDocument) return;
    
    pdfDocument.getPage(pageNum).then(function(page) {
        const viewport = page.getViewport({ scale: 1.0 });
        
        const container = document.getElementById('pdfPreview');
        const containerWidth = container.clientWidth - 40;
        const containerHeight = container.clientHeight - 40;
        
        // Calculate scale to fit the page within the container
        const scaleX = containerWidth / viewport.width;
        const scaleY = containerHeight / viewport.height;
        const scale = Math.min(scaleX, scaleY);
        
        const scaledViewport = page.getViewport({ scale: scale });
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = scaledViewport.height;
        canvas.width = scaledViewport.width;
        
        // Clear container and add canvas
        container.innerHTML = '';
        container.appendChild(canvas);
        
        // Center the canvas within the container
        canvas.style.maxWidth = '100%';
        canvas.style.maxHeight = '100%';
        canvas.style.objectFit = 'contain';
        
        const renderContext = {
            canvasContext: context,
            viewport: scaledViewport
        };
        
        page.render(renderContext).promise.then(function() {
            if (document.getElementById('addSignature').checked) {
                // Don't auto-create overlay, let user add manually
            }
        });
    }).catch(function(error) {
        console.error('Error rendering page:', error);
        showMessage('Error rendering PDF page.', 'error');
    });
}

function updatePageNavigation() {
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
    
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updatePageNavigation();
        renderPage(currentPage);
    }
}

function createSignatureOverlay() {
    signatureBoxCounter++;
    
    const signatureOverlay = document.createElement('div');
    signatureOverlay.id = `signatureBox_${signatureBoxCounter}`;
    signatureOverlay.style.position = 'absolute';
    signatureOverlay.style.border = '2px dashed #007bff';
    signatureOverlay.style.background = 'rgba(0, 123, 255, 0.1)';
    signatureOverlay.style.cursor = 'move';
    signatureOverlay.style.minWidth = '100px';
    signatureOverlay.style.minHeight = '50px';
    signatureOverlay.style.display = 'flex';
    signatureOverlay.style.alignItems = 'center';
    signatureOverlay.style.justifyContent = 'center';
    signatureOverlay.style.color = '#007bff';
    signatureOverlay.style.fontSize = '12px';
    signatureOverlay.style.fontWeight = '500';
    signatureOverlay.style.zIndex = '1000';
    
    // Get current signature preview
    const signaturePreview = getCurrentSignaturePreview();
    
    signatureOverlay.innerHTML = `
        <div style="position: relative; width: 100%; height: 100%; cursor: move;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 1;">
                ${signaturePreview}
            </div>
            <div style="position: absolute; top: -8px; right: -8px; width: 16px; height: 16px; background: #dc3545; border: 1px solid #fff; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: bold; z-index: 1002;" onclick="removeSignatureBox('${signatureOverlay.id}')">×</div>
            <div style="position: absolute; width: 8px; height: 8px; background: #007bff; border: 1px solid #fff; border-radius: 50%; cursor: se-resize; bottom: -4px; right: -4px; z-index: 1001;"></div>
        </div>
    `;
    
    const container = document.getElementById('pdfPreview');
    container.appendChild(signatureOverlay);
    
    // Position in center initially
    const containerRect = container.getBoundingClientRect();
    signatureOverlay.style.left = (containerRect.width - 100) / 2 + 'px';
    signatureOverlay.style.top = (containerRect.height - 50) / 2 + 'px';
    
    makeDraggable(signatureOverlay);
    makeResizable(signatureOverlay);
    
    signatureOverlays.push(signatureOverlay);
}

function removeSignatureBox(boxId) {
    const box = document.getElementById(boxId);
    if (box) {
        box.remove();
        signatureOverlays = signatureOverlays.filter(overlay => overlay.id !== boxId);
        saveStateToSession();
    }
}

function clearAllSignatureOverlays() {
    signatureOverlays.forEach(overlay => overlay.remove());
    signatureOverlays = [];
    saveStateToSession();
}

function getCurrentSignaturePreview() {
    const signatureType = document.querySelector('input[name="signatureType"]:checked').value;
    console.log('Current signature type:', signatureType);
    console.log('Signature data length:', signatureData.length);
    console.log('Type signature text:', typeSignatureData.text);
    
    if (signatureType === 'drawn') {
        if (signatureData.length > 0) {
            // Create a small canvas to show the drawn signature
            const previewCanvas = document.createElement('canvas');
            previewCanvas.width = 80;
            previewCanvas.height = 40;
            const previewCtx = previewCanvas.getContext('2d');
            
            // Set up the context
            previewCtx.strokeStyle = '#000';
            previewCtx.lineWidth = 1;
            previewCtx.lineCap = 'round';
            previewCtx.lineJoin = 'round';
            
            // Scale the signature to fit the preview
            const scale = Math.min(80 / 300, 40 / 150);
            previewCtx.scale(scale, scale);
            
            // Draw the signature
            signatureData.forEach(path => {
                if (path.length > 0) {
                    previewCtx.beginPath();
                    previewCtx.moveTo(path[0].x, path[0].y);
                    path.forEach(point => {
                        previewCtx.lineTo(point.x, point.y);
                    });
                    previewCtx.stroke();
                }
            });
            
            return `<img src="${previewCanvas.toDataURL()}" style="max-width: 100%; max-height: 100%; pointer-events: none;" />`;
        } else {
            return '<div style="color: #6c757d; font-size: 10px; pointer-events: none;">Draw signature</div>';
        }
    } else {
        if (typeSignatureData.text) {
            return `<span style="font-family: '${typeSignatureData.font}', cursive; font-size: 14px; color: #000; pointer-events: none;">${typeSignatureData.text}</span>`;
        } else {
            return '<div style="color: #6c757d; font-size: 10px; pointer-events: none;">Type signature</div>';
        }
    }
}

function makeDraggable(element) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;
    
    element.addEventListener('mousedown', function(e) {
        console.log('Mouse down on element:', e.target);
        console.log('Target cursor:', e.target.style.cursor);
        
        // Don't start dragging if clicking on resize handle or remove button
        if (e.target.style.cursor === 'se-resize') {
            console.log('Blocked by resize handle');
            return;
        }
        if (e.target.onclick && e.target.onclick.toString().includes('removeSignatureBox')) {
            console.log('Blocked by remove button');
            return;
        }
        
        // Only allow dragging from the main container div
        if (e.target !== element && !element.contains(e.target)) {
            console.log('Blocked - not clicking on draggable area');
            return;
        }
        
        console.log('Starting drag');
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;
        
        element.style.cursor = 'grabbing';
        e.preventDefault();
        e.stopPropagation();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        element.style.left = (startLeft + deltaX) + 'px';
        element.style.top = (startTop + deltaY) + 'px';
    });
    
    document.addEventListener('mouseup', function() {
        if (isDragging) {
            console.log('Ending drag');
            isDragging = false;
            element.style.cursor = 'move';
        }
    });
}

function makeResizable(element) {
    const handle = element.querySelector('div:last-child');
    let isResizing = false;
    let startX, startY, startWidth, startHeight;
    
    handle.addEventListener('mousedown', function(e) {
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = element.offsetWidth;
        startHeight = element.offsetHeight;
        
        e.stopPropagation();
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        const newWidth = Math.max(100, startWidth + deltaX);
        const newHeight = Math.max(50, startHeight + deltaY);
        
        element.style.width = newWidth + 'px';
        element.style.height = newHeight + 'px';
    });
    
    document.addEventListener('mouseup', function() {
        isResizing = false;
    });
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureData = [];
    signatureHistory = [];
    updateAllSignatureOverlays();
}

function undoSignature() {
    if (signatureHistory.length > 0) {
        signatureHistory.pop();
        signatureData = [...signatureHistory];
        redrawCanvas();
        updateAllSignatureOverlays();
    }
}

function redrawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureData.forEach(path => {
        if (path.length > 0) {
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            path.forEach(point => {
                ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();
        }
    });
}

function updateTypeSignature() {
    const text = document.getElementById('typeSignature').value;
    typeSignatureData.text = text;
    showSignaturePreview();
    updateAllSignatureOverlays();
}

function showSignaturePreview() {
    const preview = document.getElementById('signaturePreview');
    if (typeSignatureData.text) {
        preview.innerHTML = `<span style="font-family: '${typeSignatureData.font}', cursive; font-size: 24px;">${typeSignatureData.text}</span>`;
    } else {
        preview.innerHTML = '<span class="text-muted">Signature preview will appear here</span>';
    }
}

function updateSignatureSize() {
    const size = document.getElementById('signatureSize').value;
    document.getElementById('sizeValue').textContent = size;
    
    signatureOverlays.forEach(overlay => {
        const scale = parseFloat(size);
        overlay.style.transform = `scale(${scale})`;
    });
}

function updateAllSignatureOverlays() {
    console.log('Updating all signature overlays');
    signatureOverlays.forEach(overlay => {
        const previewContainer = overlay.querySelector('div:first-child > div:first-child');
        if (previewContainer) {
            const newPreview = getCurrentSignaturePreview();
            console.log('New preview HTML:', newPreview);
            previewContainer.innerHTML = newPreview;
        }
    });
}

function processForm(e) {
    e.preventDefault();
    
    const formData = new FormData();
    
    if (!selectedFile) {
        showMessage('Please select a PDF file.', 'error');
        return;
    }
    
    formData.append('pdf_file', selectedFile);
    
    if (document.getElementById('compress').checked) {
        formData.append('compress', '1');
    }
    
    if (document.getElementById('addSignature').checked) {
        formData.append('add_signature', '1');
        
        const signatureType = document.querySelector('input[name="signatureType"]:checked').value;
        
        if (signatureType === 'drawn' && signatureData.length === 0) {
            showMessage('Please draw a signature.', 'error');
            return;
        }
        
        if (signatureType === 'typed' && !typeSignatureData.text) {
            showMessage('Please type a signature.', 'error');
            return;
        }
        
        if (signatureOverlays.length === 0) {
            showMessage('Please add at least one signature box.', 'error');
            return;
        }
        
        const signatureBoxes = signatureOverlays.map(overlay => {
            const container = document.getElementById('pdfPreview');
            const containerRect = container.getBoundingClientRect();
            const overlayRect = overlay.getBoundingClientRect();
            
            return {
                x: overlayRect.left - containerRect.left,
                y: overlayRect.top - containerRect.top,
                width: overlay.offsetWidth,
                height: overlay.offsetHeight
            };
        });
        
        const signatureDataObj = {
            type: signatureType,
            page: currentPage,
            positions: signatureBoxes,
            size: parseFloat(document.getElementById('signatureSize').value)
        };
        
        if (signatureType === 'drawn') {
            signatureDataObj.paths = signatureData;
        } else {
            signatureDataObj.text = typeSignatureData.text;
            signatureDataObj.font = typeSignatureData.font;
        }
        
        formData.append('signature_data', JSON.stringify(signatureDataObj));
    }
    
    const processBtn = document.getElementById('processBtn');
    const originalText = processBtn.innerHTML;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    processBtn.disabled = true;
    
    fetch('/admin/pdf-tool-v2/process', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        
        // Store compression stats before converting to blob
        const compressionStats = response.headers.get('X-Compression-Stats');
        
        return response.blob().then(blob => {
            return { blob, compressionStats };
        });
    })
    .then(({ blob, compressionStats }) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'processed_document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
        
        showMessage('PDF processed successfully!', 'success');
        
        if (compressionStats) {
            try {
                const stats = JSON.parse(compressionStats);
                displayCompressionStats(stats);
            } catch (e) {
                console.error('Error parsing compression stats:', e);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error processing PDF. Please try again.', 'error');
        
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
    });
}

function displayCompressionStats(stats) {
    const statsDiv = document.getElementById('compressionStats');
    const detailsDiv = document.getElementById('compressionDetails');
    
    detailsDiv.innerHTML = `
        <p><strong>Original Size:</strong> ${formatFileSize(stats.original_size)}</p>
        <p><strong>Compressed Size:</strong> ${formatFileSize(stats.compressed_size)}</p>
        <p><strong>Reduction:</strong> ${stats.reduction_percent.toFixed(1)}%</p>
    `;
    
    statsDiv.style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function saveStateToSession() {
    const state = {
        fileName: selectedFile ? selectedFile.name : null,
        fileSize: selectedFile ? selectedFile.size : null,
        compressChecked: document.getElementById('compress').checked,
        addSignatureChecked: document.getElementById('addSignature').checked,
        signatureType: document.querySelector('input[name="signatureType"]:checked')?.value || 'drawn',
        typeSignatureText: typeSignatureData.text,
        typeSignatureFont: typeSignatureData.font,
        signatureSize: document.getElementById('signatureSize').value,
        currentPage: currentPage,
        totalPages: totalPages,
        signatureData: signatureData,
        signatureOverlays: signatureOverlays.map(overlay => ({
            id: overlay.id,
            left: overlay.style.left,
            top: overlay.style.top,
            width: overlay.style.width,
            height: overlay.style.height
        }))
    };
    
    sessionStorage.setItem('pdfToolV2State', JSON.stringify(state));
}

function restoreStateFromSession() {
    const savedState = sessionStorage.getItem('pdfToolV2State');
    if (!savedState) return;
    
    try {
        const state = JSON.parse(savedState);
        
        // Restore file info if we had a file
        if (state.fileName && state.fileSize) {
            // Create a mock file object for display purposes
            const mockFile = {
                name: state.fileName,
                size: state.fileSize,
                type: 'application/pdf'
            };
            
            // Update the UI to show the file was uploaded
            const dropZone = document.getElementById('dropZone');
            const dropContent = document.getElementById('dropContent');
            const processBtn = document.getElementById('processBtn');
            
            dropZone.style.borderColor = '#28a745';
            dropZone.style.background = '#d4edda';
            dropContent.innerHTML = `
                <div style="font-size: 48px; color: #6c757d; margin-bottom: 15px;">
                    <i class="fas fa-file-pdf text-success"></i>
                </div>
                <h5>${state.fileName}</h5>
                <div style="margin-top: 10px; font-size: 14px; color: #6c757d;">${formatFileSize(state.fileSize)}</div>
                <div style="margin-top: 10px; font-size: 12px; color: #6c757d;">
                    <i class="fas fa-info-circle"></i> File will need to be re-uploaded for processing
                </div>
            `;
            
            document.getElementById('compressOption').style.opacity = '1';
            document.getElementById('compressOption').style.pointerEvents = 'auto';
            document.getElementById('signatureOption').style.opacity = '1';
            document.getElementById('signatureOption').style.pointerEvents = 'auto';
            processBtn.disabled = false;
            
            // Show PDF preview area
            document.getElementById('dropZone').style.display = 'none';
            document.getElementById('pdfPreviewArea').style.display = 'block';
            
            // Restore page navigation
            if (state.totalPages) {
                totalPages = state.totalPages;
                currentPage = state.currentPage || 1;
                updatePageNavigation();
            }
        }
        
        // Restore form state
        if (state.compressChecked) {
            document.getElementById('compress').checked = true;
        }
        
        if (state.addSignatureChecked) {
            document.getElementById('addSignature').checked = true;
            document.getElementById('signatureSection').style.display = 'block';
        }
        
        // Restore signature type
        if (state.signatureType) {
            document.querySelector(`input[name="signatureType"][value="${state.signatureType}"]`).checked = true;
            if (state.signatureType === 'drawn') {
                document.getElementById('drawnSignatureSection').style.display = 'block';
                document.getElementById('typedSignatureSection').style.display = 'none';
            } else {
                document.getElementById('drawnSignatureSection').style.display = 'none';
                document.getElementById('typedSignatureSection').style.display = 'block';
            }
        }
        
        // Restore typed signature data
        if (state.typeSignatureText) {
            typeSignatureData.text = state.typeSignatureText;
            document.getElementById('typeSignature').value = state.typeSignatureText;
            showSignaturePreview();
        }
        
        if (state.typeSignatureFont) {
            typeSignatureData.font = state.typeSignatureFont;
            document.getElementById('fontSelect').value = state.typeSignatureFont;
        }
        
        // Restore signature size
        if (state.signatureSize) {
            document.getElementById('signatureSize').value = state.signatureSize;
            document.getElementById('sizeValue').textContent = state.signatureSize;
        }
        
        // Restore drawn signature data
        if (state.signatureData && state.signatureData.length > 0) {
            signatureData = state.signatureData;
            signatureHistory = [...state.signatureData];
            redrawCanvas();
        }
        
        // Restore signature overlays
        if (state.signatureOverlays && state.signatureOverlays.length > 0) {
            state.signatureOverlays.forEach(overlayData => {
                createSignatureOverlayFromData(overlayData);
            });
        }
        
    } catch (error) {
        console.error('Error restoring state:', error);
        // Clear corrupted state
        sessionStorage.removeItem('pdfToolV2State');
    }
}

function createSignatureOverlayFromData(overlayData) {
    signatureBoxCounter++;
    
    const signatureOverlay = document.createElement('div');
    signatureOverlay.id = overlayData.id || `signatureBox_${signatureBoxCounter}`;
    signatureOverlay.style.position = 'absolute';
    signatureOverlay.style.border = '2px dashed #007bff';
    signatureOverlay.style.background = 'rgba(0, 123, 255, 0.1)';
    signatureOverlay.style.cursor = 'move';
    signatureOverlay.style.minWidth = '100px';
    signatureOverlay.style.minHeight = '50px';
    signatureOverlay.style.display = 'flex';
    signatureOverlay.style.alignItems = 'center';
    signatureOverlay.style.justifyContent = 'center';
    signatureOverlay.style.color = '#007bff';
    signatureOverlay.style.fontSize = '12px';
    signatureOverlay.style.fontWeight = '500';
    signatureOverlay.style.zIndex = '1000';
    
    // Restore position and size
    if (overlayData.left) signatureOverlay.style.left = overlayData.left;
    if (overlayData.top) signatureOverlay.style.top = overlayData.top;
    if (overlayData.width) signatureOverlay.style.width = overlayData.width;
    if (overlayData.height) signatureOverlay.style.height = overlayData.height;
    
    // Get current signature preview
    const signaturePreview = getCurrentSignaturePreview();
    
    signatureOverlay.innerHTML = `
        <div style="position: relative; width: 100%; height: 100%; cursor: move;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 1;">
                ${signaturePreview}
            </div>
            <div style="position: absolute; top: -8px; right: -8px; width: 16px; height: 16px; background: #dc3545; border: 1px solid #fff; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: bold; z-index: 1002;" onclick="removeSignatureBox('${signatureOverlay.id}')">×</div>
            <div style="position: absolute; width: 8px; height: 8px; background: #007bff; border: 1px solid #fff; border-radius: 50%; cursor: se-resize; bottom: -4px; right: -4px; z-index: 1001;"></div>
        </div>
    `;
    
    const container = document.getElementById('pdfPreview');
    container.appendChild(signatureOverlay);
    
    makeDraggable(signatureOverlay);
    makeResizable(signatureOverlay);
    
    signatureOverlays.push(signatureOverlay);
}

function showMessage(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="border-radius: 8px; margin-bottom: 20px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid');
    const existingAlert = container.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
{% endblock %}
