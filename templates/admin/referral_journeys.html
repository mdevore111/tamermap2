{% extends "admin/base.html" %}

{% block title %}Referral Journey Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-route"></i> Referral Journey Analytics
                    </h3>
                    <div class="card-tools">
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setTimeRange(7)">7 Days</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary active" onclick="setTimeRange(30)">30 Days</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="setTimeRange(90)">90 Days</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Top Referral Codes by Journey Performance</h5>
                                </div>
                                <div class="card-body">
                                    <div id="referral-journeys-table">
                                        <div class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title">Journey Metrics</h5>
                                </div>
                                <div class="card-body">
                                    <div id="journey-metrics">
                                        <div class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery and Chart.js -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let currentTimeRange = 30;

function setTimeRange(days) {
    currentTimeRange = days;
    $('.btn-group .btn').removeClass('active');
    $(event.target).addClass('active');
    loadReferralJourneys();
}

function loadReferralJourneys() {
    $('#referral-journeys-table').html('<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
    
    fetch(`/admin/api/analytics/referral-journeys?days=${currentTimeRange}&limit=10`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayReferralJourneys(data.data);
                updateJourneyMetrics(data.data);
            } else {
                $('#referral-journeys-table').html('<div class="alert alert-danger">Error loading data: ' + data.error + '</div>');
            }
        })
        .catch(error => {
            $('#referral-journeys-table').html('<div class="alert alert-danger">Error loading data: ' + error + '</div>');
        });
}

function displayReferralJourneys(data) {
    if (!data || data.length === 0) {
        $('#referral-journeys-table').html('<div class="alert alert-info">No referral journey data available for the selected time period.</div>');
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Referral Code</th>
                        <th>Total Visits</th>
                        <th>Unique Visitors</th>
                        <th>Avg Session Duration</th>
                        <th>Conversion Rate</th>
                        <th>Return Visits</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.forEach(item => {
        const journey = item.journey_data;
        html += `
            <tr>
                <td><strong>${item.ref_code}</strong></td>
                <td>${item.total_visits.toLocaleString()}</td>
                <td>${item.unique_visitors.toLocaleString()}</td>
                <td>${journey.avg_session_duration} min</td>
                <td>${journey.conversion_rate}%</td>
                <td>${journey.return_visits}</td>
                <td>
                    <a href="/admin/referral-journey/${encodeURIComponent(item.ref_code)}?days=${currentTimeRange}" 
                       class="btn btn-sm btn-primary">
                        <i class="fas fa-chart-line"></i> Details
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    $('#referral-journeys-table').html(html);
}

function updateJourneyMetrics(data) {
    if (!data || data.length === 0) {
        $('#journey-metrics').html('<div class="alert alert-info">No metrics available.</div>');
        return;
    }
    
    // Calculate aggregate metrics
    const totalVisits = data.reduce((sum, item) => sum + item.total_visits, 0);
    const totalUniqueVisitors = data.reduce((sum, item) => sum + item.unique_visitors, 0);
    const avgSessionDuration = data.reduce((sum, item) => sum + item.journey_data.avg_session_duration, 0) / data.length;
    const avgConversionRate = data.reduce((sum, item) => sum + item.journey_data.conversion_rate, 0) / data.length;
    const totalReturnVisits = data.reduce((sum, item) => sum + item.journey_data.return_visits, 0);
    
    let html = `
        <div class="row">
            <div class="col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Visits</span>
                        <span class="info-box-number">${totalVisits.toLocaleString()}</span>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-success"><i class="fas fa-user-friends"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Unique Visitors</span>
                        <span class="info-box-number">${totalUniqueVisitors.toLocaleString()}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-warning"><i class="fas fa-clock"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Avg Session</span>
                        <span class="info-box-number">${avgSessionDuration.toFixed(1)} min</span>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="info-box">
                    <span class="info-box-icon bg-primary"><i class="fas fa-percentage"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Avg Conversion</span>
                        <span class="info-box-number">${avgConversionRate.toFixed(1)}%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="info-box">
                    <span class="info-box-icon bg-secondary"><i class="fas fa-redo"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Total Return Visits</span>
                        <span class="info-box-number">${totalReturnVisits.toLocaleString()}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('#journey-metrics').html(html);
}

// Load data on page load
$(document).ready(function() {
    loadReferralJourneys();
});
</script>

<style>
.info-box {
    display: flex;
    min-height: 80px;
    background: #fff;
    width: 100%;
    box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2);
    border-radius: 0.25rem;
    margin-bottom: 1rem;
}

.info-box-icon {
    border-radius: 0.25rem 0 0 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.875rem;
    font-weight: 700;
    width: 70px;
    text-align: center;
    color: #fff;
}

.info-box-content {
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 80px;
    flex: 1;
    padding: 0 10px;
}

.info-box-text {
    display: block;
    font-size: 0.875rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: #6c757d;
}

.info-box-number {
    display: block;
    font-weight: 700;
    font-size: 1.25rem;
}
</style>
{% endblock %} 