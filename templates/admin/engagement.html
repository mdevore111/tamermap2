{% extends 'admin/master.html' %}
{% block title %}Engagement Analytics{% endblock %}

{% block body %}
<div class="container-fluid">
  <h2 class="mt-3">Engagement Analytics</h2>
  
  {# Timeline Slider #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="form-group mb-0 d-flex align-items-center">
      <label for="daysSlider" class="form-label me-2">Time Period:</label>
      <div class="d-flex align-items-center" style="min-width: 200px;">
        <input type="range" id="daysSlider" class="form-range me-2" min="1" max="60" value="{{ days }}" style="flex: 1;">
        <span id="daysDisplay" class="badge bg-primary">{{ days }} days</span>
      </div>
    </div>
    <div>
      <small class="text-muted" id="timezoneInfo">All times shown in UTC (server time)</small>
    </div>
  </div>
  
  <p class="text-muted">Last <span id="days-display">{{ days }}</span> days</p>

  <div class="row g-3">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Route Planner Opens (sessions)</div>
          <div class="h4 mb-0">{{ sessions_open }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Route Planner Completed (sessions)</div>
          <div class="h4 mb-0">{{ sessions_go }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Completion Rate</div>
          <div class="h4 mb-0">{{ (completion_rate * 100)|round(1) }}%</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Route Events</div>
          <div class="small">open: {{ route_totals.get('open', 0) }}, preview: {{ route_totals.get('preview', 0) }}, go: {{ route_totals.get('go', 0) }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header">Legend Clicks (Top 10, Pro vs Non‑Pro)</div>
    <div class="card-body">
      <canvas id="legendBar" height="120"></canvas>
    </div>
  </div>

  <div class="card mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Recent Legend Clicks</span>
      <div>
        <small class="text-muted" id="legendTimezoneInfo">All times shown in UTC (server time)</small>
        <small class="text-muted ms-3">Latest 200</small>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm" id="recentLegendTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Session</th>
              <th>Pro</th>
              <th>Control</th>
              <th>Path</th>
              <th>Zoom</th>
              <th>Center (lat,lng)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const legendData = {{ legend_data|tojson }};
const labels = legendData.map(r => r.control_id);
const pro = legendData.map(r => r.pro);
const nonPro = legendData.map(r => r.non_pro);

const ctx = document.getElementById('legendBar').getContext('2d');
new Chart(ctx, {
  type: 'bar',
  data: {
    labels,
    datasets: [
      { label: 'Pro', data: pro, backgroundColor: 'rgba(59, 91, 219, 0.7)' },
      { label: 'Non‑Pro', data: nonPro, backgroundColor: 'rgba(233, 236, 239, 0.9)', borderColor:'#adb5bd', borderWidth:1 }
    ]
  },
  options: {
    responsive: true,
    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
    plugins: { legend: { position: 'top' } }
  }
});
</script>
<script>
// Load recent legend clicks
fetch('/admin/api/admin/engagement/legend/recent')
  .then(r => r.json())
  .then(resp => {
    // Update timezone info if available
    if (resp.timezone_info) {
      document.getElementById('legendTimezoneInfo').textContent = resp.timezone_info;
    }
    
    const tbody = document.querySelector('#recentLegendTable tbody');
    tbody.innerHTML = '';
    (resp.data || []).forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.created_at || ''}</td>
        <td><code>${row.session_id || ''}</code></td>
        <td>${row.is_pro ? 'Yes' : 'No'}</td>
        <td>${row.control_id || ''}</td>
        <td>${row.path || ''}</td>
        <td>${row.zoom ?? ''}</td>
        <td>${(row.center_lat ?? '')}${row.center_lat != null ? ',' : ''}${row.center_lng ?? ''}</td>
      `;
      tbody.appendChild(tr);
    });
  });

// Timeline slider functionality
let updateTimeout;
const daysSlider = document.getElementById('daysSlider');
const daysDisplay = document.getElementById('daysDisplay');
const daysDisplayText = document.getElementById('days-display');

// Update display when slider changes
daysSlider.addEventListener('input', function() {
  const days = this.value;
  daysDisplay.textContent = days + ' days';
  daysDisplayText.textContent = days;
  
  // Clear previous timeout
  if (updateTimeout) {
    clearTimeout(updateTimeout);
  }
  
  // Debounce the AJAX calls (wait 500ms after user stops sliding)
  updateTimeout = setTimeout(() => {
    updateEngagementData(days);
  }, 500);
});

// Function to update all engagement data
function updateEngagementData(days) {
  // Show loading state
  showLoadingState();
  
  // Update all engagement sections
  Promise.all([
    updateEngagementStats(days),
    updateLegendChart(days),
    updateRecentLegendClicks(days)
  ]).finally(() => {
    hideLoadingState();
  });
}

// Update engagement statistics
function updateEngagementStats(days) {
  return fetch(`/admin/api/admin/engagement/stats?days=${days}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the stats cards
        document.querySelector('.card:nth-child(1) .h4').textContent = data.sessions_open || '-';
        document.querySelector('.card:nth-child(2) .h4').textContent = data.sessions_go || '-';
        document.querySelector('.card:nth-child(3) .h4').textContent = 
          data.completion_rate ? (data.completion_rate * 100).toFixed(1) + '%' : '-';
        
        const routeTotals = data.route_totals || {};
        document.querySelector('.card:nth-child(4) .small').textContent = 
          `open: ${routeTotals.open || 0}, preview: ${routeTotals.preview || 0}, go: ${routeTotals.go || 0}`;
      }
    })
    .catch(error => {
      console.error('Error updating engagement stats:', error);
    });
}

// Update legend chart
function updateLegendChart(days) {
  return fetch(`/admin/api/admin/engagement/legend/chart?days=${days}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Update the chart data
        const chart = Chart.getChart('legendBar');
        if (chart) {
          chart.data.labels = data.data.map(r => r.control_id);
          chart.data.datasets[0].data = data.data.map(r => r.pro);
          chart.data.datasets[1].data = data.data.map(r => r.non_pro);
          chart.update();
        }
      }
    })
    .catch(error => {
      console.error('Error updating legend chart:', error);
    });
}

// Update recent legend clicks
function updateRecentLegendClicks(days) {
  return fetch(`/admin/api/admin/engagement/legend/recent?days=${days}`)
    .then(response => response.json())
    .then(resp => {
      // Update timezone info if available
      if (resp.timezone_info) {
        document.getElementById('legendTimezoneInfo').textContent = resp.timezone_info;
      }
      
      const tbody = document.querySelector('#recentLegendTable tbody');
      tbody.innerHTML = '';
      (resp.data || []).forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.created_at || ''}</td>
          <td><code>${row.session_id || ''}</code></td>
          <td>${row.is_pro ? 'Yes' : 'No'}</td>
          <td>${row.control_id || ''}</td>
          <td>${row.path || ''}</td>
          <td>${row.zoom ?? ''}</td>
          <td>${(row.center_lat ?? '')}${row.center_lat != null ? ',' : ''}${row.center_lng ?? ''}</td>
        `;
        tbody.appendChild(tr);
      });
    })
    .catch(error => {
      console.error('Error updating recent legend clicks:', error);
    });
}

// Show loading state
function showLoadingState() {
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    card.style.opacity = '0.6';
  });
}

// Hide loading state
function hideLoadingState() {
  const cards = document.querySelectorAll('.card');
  cards.forEach(card => {
    card.style.opacity = '1';
  });
}
</script>
{% endblock %}


