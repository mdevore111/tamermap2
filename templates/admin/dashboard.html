{% extends 'admin/master.html' %}
{% block body %}
<div class="container-fluid">
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Admin Dashboard</h1>
    <div class="d-flex">
      <span class="badge badge-primary">System Overview</span>
    </div>
  </div>





  {# Render each section of grouped tiles #}
  {% for section, tiles in dashboard_groups %}
    <div class="dashboard-section my-4">
      <h3 class="dashboard-header">{{ section }}</h3>
      <hr>
      <div class="row">
        {% for tile in tiles %}
          <div class="col-12 col-sm-6 col-md-3 mb-3">
            <div class="card h-100 shadow-sm" data-bs-toggle="tooltip" title="{{ tile.summary }}">
              <div class="card-header text-center">{{ tile.title }}</div>
              <div class="card-body text-center"><h3>{{ tile.value }}</h3></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}



  {# Top Analytics Tables #}
  <div class="dashboard-section my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="dashboard-header mb-0">Top Analytics</h3>
      <div class="form-group mb-0 d-flex align-items-center">
        <label for="daysSlider" class="form-label me-2">Time Period:</label>
        <div class="d-flex align-items-center" style="min-width: 200px;">
          <input type="range" id="daysSlider" class="form-range me-2" min="1" max="60" value="{{ days_filter }}" style="flex: 1;">
          <span id="daysDisplay" class="badge bg-primary">{{ days_filter }} days</span>
        </div>
      </div>
    </div>
    <hr>
  </div>

  {# Visit Trends bar chart #}
  <div class="dashboard-section my-5">
    <h3 class="dashboard-header">Visit Trends (<span id="chart-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <canvas id="visitChart" class="w-100" style="height:40vh;"></canvas>
  </div>

  {# Traffic by Hour chart #}
  <div class="dashboard-section my-5">
    <h3 class="dashboard-header">Traffic by Hour (<span id="hourly-chart-days">{{ days_filter }}</span> Days)</h3>
    <div class="row mb-2">
      <div class="col-md-4">
        <small class="text-muted">Total Visits: <span id="hourly-total-visits">-</span></small>
      </div>
      <div class="col-md-4">
        <small class="text-muted">Avg per Hour: <span id="hourly-avg-per-hour">-</span></small>
      </div>
      <div class="col-md-4">
        <small class="text-muted">Avg per Day: <span id="hourly-avg-per-day">-</span></small>
      </div>
    </div>
    <hr>
    <canvas id="hourlyChart" class="w-100" style="height:40vh;"></canvas>
  </div>

  {# Referral Code Trends bar chart #}
  <div class="dashboard-section my-5">
    <h3 class="dashboard-header">Top Referral Codes (<span id="ref-chart-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <canvas id="referralCodeChart" class="w-100" style="height:40vh;"></canvas>
  </div>

  <div class="dashboard-section my-5" id="top-referrers-section">
    <h3 class="dashboard-header">Top 10 External Referrers (<span id="referrers-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-referrers-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Full URL</th>
                <th>Visit Count</th>
              </tr>
            </thead>
            <tbody id="top-referrers-tbody">
              {% for referrer in top_referrers %}
              <tr>
                <td>{{ referrer.domain or 'Unknown' }}</td>
                <td>
                  <div class="text-truncate" style="max-width: 300px;">
                    <a href="{{ referrer.full_url }}" target="_blank" title="{{ referrer.full_url }}">
                      {{ referrer.full_url }}
                    </a>
                  </div>
                </td>
                <td>{{ referrer.count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-section my-5" id="top-pages-section">
    <h3 class="dashboard-header">Top 10 Pages (<span id="pages-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-pages-table">
            <thead>
              <tr>
                <th>Path</th>
                <th>Visits</th>
              </tr>
            </thead>
            <tbody id="top-pages-tbody">
              {% for path, count in top_pages %}
              <tr>
                <td>{{ path[:60] }}{% if path|length > 60 %}...{% endif %}</td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-section my-5" id="top-ref-codes-section">
    <h3 class="dashboard-header">Top 10 Referral Codes (<span id="ref-codes-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-ref-codes-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Usage Count</th>
              </tr>
            </thead>
            <tbody id="top-ref-codes-tbody">
              {% for ref_code, count in top_ref_codes %}
              <tr>
                <td>{{ ref_code or 'None' }}</td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{# Scripts for charts #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Visit Trends Chart
  const ctx = document.getElementById('visitChart').getContext('2d');
  let visitChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ chart_data.labels|tojson }},
      datasets: [
        { label: 'Total Visits', data: {{ chart_data.total|tojson }}, backgroundColor: 'rgba(54, 162, 235, 0.5)' },
        { label: 'Pro User Visits', data: {{ chart_data.registered|tojson }}, backgroundColor: 'rgba(75, 192, 192, 0.5)' },
        { label: 'Guest Visits', data: {{ chart_data.guests|tojson }}, backgroundColor: 'rgba(255, 99, 132, 0.5)' },
        { 
          label: '7-Day Moving Average', 
          data: {{ chart_data.moving_average|tojson if chart_data.moving_average else '[]' }}, 
          type: 'line',
          borderColor: 'rgba(255, 159, 64, 1)',
          backgroundColor: 'rgba(255, 159, 64, 0.2)',
          borderWidth: 3,
          fill: false,
          tension: 0.1,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    },
    options: { 
      responsive: true, 
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: {
          labels: {
            usePointStyle: true
          }
        }
      }
    }
  });

  // Traffic by Hour Chart
  const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
  let hourlyChart = new Chart(hourlyCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [
        { 
          label: 'Average Visits per Day', 
          data: [], 
          backgroundColor: 'rgba(153, 102, 255, 0.7)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        },
        {
          label: 'Overall Average per Hour',
          data: [],
          type: 'line',
          borderColor: 'rgba(255, 99, 132, 1)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderWidth: 2,
          fill: false,
          tension: 0,
          pointRadius: 0,
          pointHoverRadius: 0,
          borderDash: [5, 5]
        }
      ]
    },
    options: { 
      responsive: true, 
      scales: { 
        y: { 
          beginAtZero: true,
          title: {
            display: true,
            text: 'Average Visits per Day'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Hour of Day'
          }
        }
      },
      plugins: {
        legend: {
          labels: {
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              if (context.datasetIndex === 0) {
                return `Hour ${context.label}: ${context.parsed.y} avg visits/day`;
              } else {
                return `Overall average: ${context.parsed.y} visits/hour`;
              }
            }
          }
        }
      }
    }
  });

  // Referral Code Trends Chart
  const refCtx = document.getElementById('referralCodeChart').getContext('2d');
  let referralCodeChart = new Chart(refCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: []
    },
    options: { 
      responsive: true, 
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: {
          labels: {
            usePointStyle: true
          }
        }
      }
    }
  });

  // Initialize referral code chart
  function initializeReferralCodeChart() {
    fetch('/admin/api/analytics/referral-code-trends?days={{ days_filter }}')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          updateReferralCodeChart(data.data);
        }
      })
      .catch(error => {
        console.error('Error loading referral code trends:', error);
      });
  }

  // Initialize traffic by hour chart
  function initializeTrafficByHour() {
    fetch('/admin/api/analytics/traffic-by-hour?days={{ days_filter }}')
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update chart data
          hourlyChart.data.labels = data.data.map(item => item.hour_display);
          hourlyChart.data.datasets[0].data = data.data.map(item => item.avg_visits_per_day);
          
          // Add average line across all hours
          const avgLine = new Array(24).fill(data.avg_visits_per_hour);
          hourlyChart.data.datasets[1].data = avgLine;
          
          // Update the chart
          hourlyChart.update();
        }
      })
      .catch(error => {
        console.error('Error loading traffic by hour:', error);
      });
  }

  // Analytics slider functionality
  let updateTimeout;
  const daysSlider = document.getElementById('daysSlider');
  const daysDisplay = document.getElementById('daysDisplay');
  
  // Update display when slider changes
  daysSlider.addEventListener('input', function() {
    const days = this.value;
    daysDisplay.textContent = days + ' days';
    
    // Clear previous timeout
    if (updateTimeout) {
      clearTimeout(updateTimeout);
    }
    
    // Debounce the AJAX calls (wait 500ms after user stops sliding)
    updateTimeout = setTimeout(() => {
      updateAnalyticsData(days);
    }, 500);
  });
  
  // Function to update all analytics data
  function updateAnalyticsData(days) {
    // Show loading state
    showLoadingState();
    
    // Update all four analytics sections (including charts)
    Promise.all([
      updateTopReferrers(days),
      updateTopPages(days),
      updateTopRefCodes(days),
      updateVisitTrends(days),
      updateTrafficByHour(days),
      updateReferralCodeTrends(days)
    ]).finally(() => {
      hideLoadingState();
    });
  }
  
  // Update top referrers
  function updateTopReferrers(days) {
    return fetch(`/admin/api/analytics/top-referrers?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-referrers-tbody');
          const daysSpan = document.getElementById('referrers-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(referrer => `
            <tr>
              <td>${referrer.domain || 'Unknown'}</td>
              <td>
                <div class="text-truncate" style="max-width: 300px;">
                  <a href="${referrer.full_url}" target="_blank" title="${referrer.full_url}">
                    ${referrer.full_url}
                  </a>
                </div>
              </td>
              <td>${referrer.count}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating referrers:', error);
        showError('Failed to update referrers data');
      });
  }
  
  // Update top pages
  function updateTopPages(days) {
    return fetch(`/admin/api/analytics/top-pages?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-pages-tbody');
          const daysSpan = document.getElementById('pages-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(page => `
            <tr>
              <td>${page[0].length > 60 ? page[0].substring(0, 60) + '...' : page[0]}</td>
              <td>${page[1]}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating pages:', error);
        showError('Failed to update pages data');
      });
  }
  
  // Update top referral codes
  function updateTopRefCodes(days) {
    return fetch(`/admin/api/analytics/top-ref-codes?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-ref-codes-tbody');
          const daysSpan = document.getElementById('ref-codes-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(refCode => `
            <tr>
              <td>${refCode[0] || 'None'}</td>
              <td>${refCode[1]}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating referral codes:', error);
        showError('Failed to update referral codes data');
      });
  }
  
  // Show loading state
  function showLoadingState() {
    const sections = ['top-referrers-section', 'top-pages-section', 'top-ref-codes-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.opacity = '0.6';
      }
    });
    
    // Also fade the chart section
    const chartSection = document.querySelector('.dashboard-section:has(#visitChart)');
    if (chartSection) {
      chartSection.style.opacity = '0.6';
    }
  }
  
  // Hide loading state
  function hideLoadingState() {
    const sections = ['top-referrers-section', 'top-pages-section', 'top-ref-codes-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.opacity = '1';
      }
    });
    
    // Also restore the chart section
    const chartSection = document.querySelector('.dashboard-section:has(#visitChart)');
    if (chartSection) {
      chartSection.style.opacity = '1';
    }
  }
  
  // Update visit trends chart
  function updateVisitTrends(days) {
    return fetch(`/admin/api/analytics/visit-trends?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const daysSpan = document.getElementById('chart-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update chart data
          visitChart.data.labels = data.data.labels;
          visitChart.data.datasets[0].data = data.data.total;
          visitChart.data.datasets[1].data = data.data.registered;
          visitChart.data.datasets[2].data = data.data.guests;
          visitChart.data.datasets[3].data = data.data.moving_average;
          
          // Update the chart
          visitChart.update();
        }
      })
      .catch(error => {
        console.error('Error updating visit trends:', error);
        showError('Failed to update visit trends data');
      });
  }

  // Update traffic by hour chart
  function updateTrafficByHour(days) {
    return fetch(`/admin/api/analytics/traffic-by-hour?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const daysSpan = document.getElementById('hourly-chart-days');
          const totalVisitsSpan = document.getElementById('hourly-total-visits');
          const avgPerHourSpan = document.getElementById('hourly-avg-per-hour');
          const avgPerDaySpan = document.getElementById('hourly-avg-per-day');
          
          // Update days display
          daysSpan.textContent = days;
          totalVisitsSpan.textContent = data.total_visits || '-';
          avgPerHourSpan.textContent = data.avg_visits_per_hour || '-';
          
          // Calculate average visits per day
          const avgPerDay = data.total_visits ? (data.total_visits / days).toFixed(1) : '-';
          avgPerDaySpan.textContent = avgPerDay;
          
          // Update chart data
          hourlyChart.data.labels = data.data.map(item => item.hour_display);
          hourlyChart.data.datasets[0].data = data.data.map(item => item.avg_visits_per_day);
          
          // Add average line across all hours
          const avgLine = new Array(24).fill(data.avg_visits_per_hour);
          hourlyChart.data.datasets[1].data = avgLine;
          
          // Update the chart
          hourlyChart.update();
        }
      })
      .catch(error => {
        console.error('Error updating traffic by hour:', error);
        showError('Failed to update traffic by hour data');
      });
  }

  // Update referral code trends chart
  function updateReferralCodeTrends(days) {
    return fetch(`/admin/api/analytics/referral-code-trends?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const daysSpan = document.getElementById('ref-chart-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update chart data
          updateReferralCodeChart(data.data);
        }
      })
      .catch(error => {
        console.error('Error updating referral code trends:', error);
        showError('Failed to update referral code trends data');
      });
  }

  // Update referral code chart with new data
  function updateReferralCodeChart(data) {
    const colors = [
      'rgba(54, 162, 235, 0.5)',
      'rgba(255, 99, 132, 0.5)',
      'rgba(75, 192, 192, 0.5)',
      'rgba(255, 159, 64, 0.5)',
      'rgba(153, 102, 255, 0.5)',
      'rgba(255, 205, 86, 0.5)'
    ];
    
    const lineColors = [
      'rgba(54, 162, 235, 1)',
      'rgba(255, 99, 132, 1)',
      'rgba(75, 192, 192, 1)',
      'rgba(255, 159, 64, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 205, 86, 1)'
    ];

    // Clear existing datasets
    referralCodeChart.data.labels = data.dates;
    referralCodeChart.data.datasets = [];

    // Add bar datasets for each code
    data.codes.forEach((code, index) => {
      const barData = data.data.map(day => day[code] || 0);
      const avgData = data.data.map(day => day[`${code}_avg`] || 0);
      
      // Add bar dataset
      referralCodeChart.data.datasets.push({
        label: `Code: ${code}`,
        data: barData,
        backgroundColor: colors[index % colors.length],
        borderColor: colors[index % colors.length].replace('0.5', '1'),
        borderWidth: 1,
        type: 'bar'
      });
      
      // Add line dataset for moving average
      referralCodeChart.data.datasets.push({
        label: `${code} - 7-Day Avg`,
        data: avgData,
        borderColor: lineColors[index % lineColors.length],
        backgroundColor: lineColors[index % lineColors.length].replace('1', '0.2'),
        borderWidth: 2,
        fill: false,
        tension: 0.1,
        pointRadius: 3,
        pointHoverRadius: 5,
        type: 'line'
      });
    });

    // Update the chart
    referralCodeChart.update();
  }
  
  // Show error message
  function showError(message) {
    // You can implement a toast notification here
    console.error(message);
  }
  
  // Show toast notification
  function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
      document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 300px; margin-bottom: 10px;';
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
      }
    }, 5000);
  }

  // Initialize charts on page load
  document.addEventListener('DOMContentLoaded', function() {
    initializeReferralCodeChart();
    initializeTrafficByHour(); // Initialize traffic by hour on page load
  });
  

</script>
{% endblock %}
<!-- touch -->