{% extends 'admin/master.html' %}
{% block body %}
<div class="container-fluid">
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Admin Dashboard</h1>
    <div class="d-flex">
      <span class="badge badge-primary">System Overview</span>
    </div>
  </div>

  {# Quick Access Widgets for New Admin Views #}
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Future Events
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <a href="{{ url_for('admin.events') }}" class="text-decoration-none">
                  View Events <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-calendar-plus fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Top Pages
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <a href="{{ url_for('admin.top_pages') }}" class="text-decoration-none">
                  View Pages <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-file-alt fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                Top Referrers
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <a href="{{ url_for('admin.top_referrers') }}" class="text-decoration-none">
                  View Referrers <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-external-link-alt fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                Visitor Logs
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <a href="{{ url_for('admin.visitors') }}" class="text-decoration-none">
                  View Logs <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                Setup Intents
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <a href="{{ url_for('admin.setup_intents') }}" class="text-decoration-none">
                  Manage Payments <i class="fas fa-arrow-right"></i>
                </a>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-credit-card fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Render each section of grouped tiles #}
  {% for section, tiles in dashboard_groups %}
    <div class="dashboard-section my-4">
      <h3 class="dashboard-header">{{ section }}</h3>
      <hr>
      <div class="row">
        {% for tile in tiles %}
          <div class="col-12 col-sm-6 col-md-3 mb-3">
            <div class="card h-100 shadow-sm" data-bs-toggle="tooltip" title="{{ tile.summary }}">
              <div class="card-header text-center">{{ tile.title }}</div>
              <div class="card-body text-center"><h3>{{ tile.value }}</h3></div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}

  {# System Resource Monitoring: progress bars #}
  <div class="dashboard-section my-5">
    <h3 class="dashboard-header">System Resource Monitoring</h3>
    <hr>
    <div class="row text-center">
      <div class="col-12 col-sm-4 mb-3">
        <h5>CPU Usage: {{ system_stats.cpu }}%</h5>
        <div class="progress" style="height: 1.5rem;">
          <div class="progress-bar {% if system_stats.cpu < 50 %}bg-success{% elif system_stats.cpu < 75 %}bg-warning{% else %}bg-danger{% endif %}"
               role="progressbar" style="width: {{ system_stats.cpu }}%;"
               aria-valuenow="{{ system_stats.cpu }}" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-4 mb-3">
        <h5>Memory Usage: {{ system_stats.memory }}% ({{ system_stats.memory_used }}GB / {{ system_stats.memory_total }}GB)</h5>
        <div class="progress" style="height: 1.5rem;">
          <div class="progress-bar {% if system_stats.memory < 50 %}bg-success{% elif system_stats.memory < 75 %}bg-warning{% else %}bg-danger{% endif %}"
               role="progressbar" style="width: {{ system_stats.memory }}%;"
               aria-valuenow="{{ system_stats.memory }}" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-4 mb-3">
        <h5>Disk Usage: {{ system_stats.disk }}% ({{ system_stats.disk_used }}GB / {{ system_stats.disk_total }}GB)</h5>
        <div class="progress" style="height: 1.5rem;">
          <div class="progress-bar {% if system_stats.disk < 50 %}bg-success{% elif system_stats.disk < 75 %}bg-warning{% else %}bg-danger{% endif %}"
               role="progressbar" style="width: {{ system_stats.disk }}%;"
               aria-valuenow="{{ system_stats.disk }}" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Top Analytics Tables #}
  <div class="dashboard-section my-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="dashboard-header mb-0">Top Analytics</h3>
      <div class="form-group mb-0 d-flex align-items-center">
        <label for="daysSlider" class="form-label me-2">Time Period:</label>
        <div class="d-flex align-items-center" style="min-width: 200px;">
          <input type="range" id="daysSlider" class="form-range me-2" min="1" max="60" value="{{ days_filter }}" style="flex: 1;">
          <span id="daysDisplay" class="badge bg-primary">{{ days_filter }} days</span>
        </div>
      </div>
    </div>
    <hr>
  </div>

  {# Visit Trends bar chart #}
  <div class="dashboard-section my-5">
    <h3 class="dashboard-header">Visit Trends (<span id="chart-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <canvas id="visitChart" class="w-100" style="height:40vh;"></canvas>
  </div>

  <div class="dashboard-section my-5" id="top-referrers-section">
    <h3 class="dashboard-header">Top 10 External Referrers (<span id="referrers-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-referrers-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Full URL</th>
                <th>Visit Count</th>
              </tr>
            </thead>
            <tbody id="top-referrers-tbody">
              {% for referrer in top_referrers %}
              <tr>
                <td>{{ referrer.domain or 'Unknown' }}</td>
                <td>
                  <div class="text-truncate" style="max-width: 300px;">
                    <a href="{{ referrer.full_url }}" target="_blank" title="{{ referrer.full_url }}">
                      {{ referrer.full_url }}
                    </a>
                  </div>
                </td>
                <td>{{ referrer.count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-section my-5" id="top-pages-section">
    <h3 class="dashboard-header">Top 10 Pages (<span id="pages-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-pages-table">
            <thead>
              <tr>
                <th>Path</th>
                <th>Visits</th>
              </tr>
            </thead>
            <tbody id="top-pages-tbody">
              {% for path, count in top_pages %}
              <tr>
                <td>{{ path[:60] }}{% if path|length > 60 %}...{% endif %}</td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-section my-5" id="top-ref-codes-section">
    <h3 class="dashboard-header">Top 10 Referral Codes (<span id="ref-codes-days">{{ days_filter }}</span> Days)</h3>
    <hr>
    <div class="row">
      <div class="col-12">
        <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="top-ref-codes-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Usage Count</th>
              </tr>
            </thead>
            <tbody id="top-ref-codes-tbody">
              {% for ref_code, count in top_ref_codes %}
              <tr>
                <td>{{ ref_code or 'None' }}</td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{# Scripts for charts #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Visit Trends Chart
  const ctx = document.getElementById('visitChart').getContext('2d');
  let visitChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: {{ chart_data.labels|tojson }},
      datasets: [
        { label: 'Total Visits', data: {{ chart_data.total|tojson }}, backgroundColor: 'rgba(54, 162, 235, 0.5)' },
        { label: 'Pro User Visits', data: {{ chart_data.registered|tojson }}, backgroundColor: 'rgba(75, 192, 192, 0.5)' },
        { label: 'Guest Visits', data: {{ chart_data.guests|tojson }}, backgroundColor: 'rgba(255, 99, 132, 0.5)' },
        { 
          label: '7-Day Moving Average', 
          data: {{ chart_data.moving_average|tojson if chart_data.moving_average else '[]' }}, 
          type: 'line',
          borderColor: 'rgba(255, 159, 64, 1)',
          backgroundColor: 'rgba(255, 159, 64, 0.2)',
          borderWidth: 3,
          fill: false,
          tension: 0.1,
          pointRadius: 4,
          pointHoverRadius: 6
        }
      ]
    },
    options: { 
      responsive: true, 
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: {
          labels: {
            usePointStyle: true
          }
        }
      }
    }
  });

  // Analytics slider functionality
  let updateTimeout;
  const daysSlider = document.getElementById('daysSlider');
  const daysDisplay = document.getElementById('daysDisplay');
  
  // Update display when slider changes
  daysSlider.addEventListener('input', function() {
    const days = this.value;
    daysDisplay.textContent = days + ' days';
    
    // Clear previous timeout
    if (updateTimeout) {
      clearTimeout(updateTimeout);
    }
    
    // Debounce the AJAX calls (wait 500ms after user stops sliding)
    updateTimeout = setTimeout(() => {
      updateAnalyticsData(days);
    }, 500);
  });
  
  // Function to update all analytics data
  function updateAnalyticsData(days) {
    // Show loading state
    showLoadingState();
    
    // Update all four analytics sections (including chart)
    Promise.all([
      updateTopReferrers(days),
      updateTopPages(days),
      updateTopRefCodes(days),
      updateVisitTrends(days)
    ]).finally(() => {
      hideLoadingState();
    });
  }
  
  // Update top referrers
  function updateTopReferrers(days) {
    return fetch(`/admin/api/analytics/top-referrers?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-referrers-tbody');
          const daysSpan = document.getElementById('referrers-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(referrer => `
            <tr>
              <td>${referrer.domain || 'Unknown'}</td>
              <td>
                <div class="text-truncate" style="max-width: 300px;">
                  <a href="${referrer.full_url}" target="_blank" title="${referrer.full_url}">
                    ${referrer.full_url}
                  </a>
                </div>
              </td>
              <td>${referrer.count}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating referrers:', error);
        showError('Failed to update referrers data');
      });
  }
  
  // Update top pages
  function updateTopPages(days) {
    return fetch(`/admin/api/analytics/top-pages?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-pages-tbody');
          const daysSpan = document.getElementById('pages-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(page => `
            <tr>
              <td>${page[0].length > 60 ? page[0].substring(0, 60) + '...' : page[0]}</td>
              <td>${page[1]}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating pages:', error);
        showError('Failed to update pages data');
      });
  }
  
  // Update top referral codes
  function updateTopRefCodes(days) {
    return fetch(`/admin/api/analytics/top-ref-codes?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const tbody = document.getElementById('top-ref-codes-tbody');
          const daysSpan = document.getElementById('ref-codes-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update table content
          tbody.innerHTML = data.data.map(refCode => `
            <tr>
              <td>${refCode[0] || 'None'}</td>
              <td>${refCode[1]}</td>
            </tr>
          `).join('');
        }
      })
      .catch(error => {
        console.error('Error updating referral codes:', error);
        showError('Failed to update referral codes data');
      });
  }
  
  // Show loading state
  function showLoadingState() {
    const sections = ['top-referrers-section', 'top-pages-section', 'top-ref-codes-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.opacity = '0.6';
      }
    });
    
    // Also fade the chart section
    const chartSection = document.querySelector('.dashboard-section:has(#visitChart)');
    if (chartSection) {
      chartSection.style.opacity = '0.6';
    }
  }
  
  // Hide loading state
  function hideLoadingState() {
    const sections = ['top-referrers-section', 'top-pages-section', 'top-ref-codes-section'];
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.opacity = '1';
      }
    });
    
    // Also restore the chart section
    const chartSection = document.querySelector('.dashboard-section:has(#visitChart)');
    if (chartSection) {
      chartSection.style.opacity = '1';
    }
  }
  
  // Update visit trends chart
  function updateVisitTrends(days) {
    return fetch(`/admin/api/analytics/visit-trends?days=${days}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const daysSpan = document.getElementById('chart-days');
          
          // Update days display
          daysSpan.textContent = days;
          
          // Update chart data
          visitChart.data.labels = data.data.labels;
          visitChart.data.datasets[0].data = data.data.total;
          visitChart.data.datasets[1].data = data.data.registered;
          visitChart.data.datasets[2].data = data.data.guests;
          visitChart.data.datasets[3].data = data.data.moving_average;
          
          // Update the chart
          visitChart.update();
        }
      })
      .catch(error => {
        console.error('Error updating visit trends:', error);
        showError('Failed to update visit trends data');
      });
  }
  
  // Show error message
  function showError(message) {
    // You can implement a toast notification here
    console.error(message);
  }
</script>
{% endblock %}
<!-- touch -->