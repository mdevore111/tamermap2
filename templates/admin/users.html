{% extends 'admin/master.html' %}

{% block body %}
    {% set title = 'Users' %}
            {% set tooltip = 'All registered users. Columns include email, names, status, roles, and actions.' %}
            {% set table_id = 'users-table' %}
    {% set columns = ['Email', 'Name', 'Active', 'Last Login', 'Roles', 'Pro', 'Admin', 'Actions'] %}
            {% set extra_header = '<div class="d-flex gap-2"><button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button><button class="btn btn-primary" id="bulkEmailBtn">Email Selected</button></div>' %}
            {% include 'admin/_datatable_card.html' %}

            <!-- Add User Modal -->
            <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="addUserForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS or rendered here -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success">Add User</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Edit User Modal -->
            <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="editUserForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS or rendered here -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (must be loaded before DataTables and custom JS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<!-- DataTables FixedHeader plugin -->
<link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
<script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function fetchRoles(callback) {
    $.get('/admin/roles', function(roles) {
        callback(roles);
    }).fail(function(jqXHR, textStatus, errorThrown) {
                    Swal.fire({
                title: 'Error!',
                text: 'Error loading roles. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
    });
}

function initServerSideTable(tableId, ajaxUrl, columns, columnDefs=[]) {
    $(tableId).DataTable({
        paging: true,
        searching: true,
        info: true,
        order: [],
        responsive: true,
        fixedHeader: true,
        scrollY: '400px', // Fixed height for table scrolling
        scrollCollapse: true,
        lengthMenu: [[25, 50, 100, 250, 500], [25, 50, 100, 250, 500]],
        pageLength: 25,
        language: { lengthMenu: 'Show _MENU_ entries per page' },
        serverSide: true,
        processing: true,
        ajax: { url: ajaxUrl, type: 'GET' },
        columns: columns,
        columnDefs: columnDefs
    });
}

$(document).ready(function() {
    initServerSideTable('#users-table', '/admin/users/data', [
        { data: 'email' },
        { data: 'name' },
        { data: 'active' },
        { data: 'last_login' },
        { data: 'roles' },
        { data: 'is_pro' },
        { data: 'is_admin', orderable: false },
        { data: 'actions', orderable: false, searchable: false }
    ]);

    // Add a Select All checkbox to the header of the first column (Email)
    function renderSelectAllHeader() {
        const th = $('#users-table thead th').eq(0);
        if (!th.find('#selectAllUsers').length) {
            th.html('<input type="checkbox" id="selectAllUsers" class="form-check-input me-2"> Email');
            $('#selectAllUsers').on('change', function(){
                const isChecked = $(this).is(':checked');
                $('#users-table tbody .user-select').prop('checked', isChecked);
            });
        }
    }
    renderSelectAllHeader();

    // Inject selection checkboxes for bulk email
    $('#users-table').on('draw.dt', function(){
        // Ensure header select-all exists and reset its state on redraw
        renderSelectAllHeader();
        const selectAll = document.getElementById('selectAllUsers');
        if (selectAll) { selectAll.checked = false; selectAll.indeterminate = false; }
        $('#users-table tbody tr').each(function(){
            const row = $(this);
            const first = row.find('td').eq(0);
            const email = first.text().trim();
            if (email && !first.find('input.user-select').length) {
                first.html(`<input type="checkbox" class="form-check-input user-select me-2"> ${email}`);
            }
        });
    });

    // Update header checkbox state when individual checkboxes change
    $(document).on('change', '#users-table tbody .user-select', function(){
        const all = $('#users-table tbody .user-select');
        const checked = $('#users-table tbody .user-select:checked');
        const selectAll = document.getElementById('selectAllUsers');
        if (!selectAll) return;
        if (all.length === 0) { selectAll.checked = false; selectAll.indeterminate = false; return; }
        selectAll.checked = checked.length === all.length;
        selectAll.indeterminate = checked.length > 0 && checked.length < all.length;
    });

    // Bulk email action
    $(document).on('click', '#bulkEmailBtn', function(){
        const emails = [];
        $('#users-table tbody tr').each(function(){
            const cb = $(this).find('input.user-select');
            if (cb.length && cb.is(':checked')) {
                const email = $(this).find('td').eq(0).text().trim();
                if (email) emails.push(email);
            }
        });
        if (emails.length === 0) { Swal.fire({ icon: 'info', title: 'No users selected' }); return; }
        const defaultSignature = 'Thank you,\nTamermap.com Staff\n\nNote: This is an automated response. Please do not reply to this email as replies will not be received.';
        Swal.fire({
            title: 'Email Selected Users',
            width: 700,
            html: `
                <input id="bulkSubject" class="swal2-input" placeholder="Subject">
                <div class="swal2-textarea" style="padding:0;border:none">
                  <textarea id="bulkBody" class="form-control" placeholder="Message" rows="8"></textarea>
                </div>
                <label class="mt-2 fw-semibold">Signature</label>
                <div class="swal2-textarea" style="padding:0;border:none">
                  <textarea id="bulkSignature" class="form-control" rows="4">${defaultSignature}</textarea>
                </div>
            `,
            showCancelButton: true,
            preConfirm: () => {
                const subject = document.getElementById('bulkSubject').value.trim();
                const body = document.getElementById('bulkBody').value.trim();
                const signature = document.getElementById('bulkSignature').value.trim();
                if (!subject || !body) { Swal.showValidationMessage('Subject and body are required'); return false; }
                return { subject, body, signature };
            }
        }).then(res => {
            if (res.isConfirmed) {
                fetch('/admin/users/bulk-email', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject: res.value.subject, body: res.value.body, signature: res.value.signature, emails })
                }).then(r => r.json()).then(resp => {
                    if (resp.success) Swal.fire({ icon: 'success', title: `Sent: ${resp.sent} Â· Failed: ${resp.failed}` });
                    else Swal.fire({ icon: 'error', title: 'Failed' });
                }).catch(() => Swal.fire({ icon: 'error', title: 'Failed' }));
            }
        });
    });

    // Add User Modal: Render form fields
    $('#addUserModal').on('show.bs.modal', function() {
        fetchRoles(function(roles) {
            var form = $('#addUserModal .modal-body');
            var rolesOptions = roles.map(r => `<option value='${r.name}'>${r.name}</option>`).join('');
            form.html(`
                <div class='mb-1'><label class='small mb-0'>First Name</label><input name='first_name' class='form-control form-control-sm'></div>
                <div class='mb-1'><label class='small mb-0'>Last Name</label><input name='last_name' class='form-control form-control-sm'></div>
                <div class='mb-1'><label class='small mb-0'>Email</label><input name='email' type='email' class='form-control form-control-sm' required></div>
                <div class='mb-1'><label class='small mb-0'>Password</label><input name='password' type='password' class='form-control form-control-sm' required pattern='(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}' title='Min 8 chars, include upper/lower and a number'></div>
                <div class='mb-1'><label class='small mb-0'>Confirm Password</label><input name='password_confirm' type='password' class='form-control form-control-sm' required></div>
                <div class='mb-1'><label class='small mb-0'>Active</label><select name='active' class='form-select form-select-sm'><option value='1'>Yes</option><option value='0'>No</option></select></div>
                <div class='mb-1'><label class='mb-0'>Pro End Date</label><input name='pro_end_date' type='date' class='form-control form-control-sm'></div>
                <div class='mb-1'><label class='small mb-0'>Roles</label><select name='roles' class='form-select form-select-sm' multiple>${rolesOptions}</select></div>
            `);
            
            // Add real-time password validation
            $('input[name="password_confirm"]').on('input', function() {
                var password = $('input[name="password"]').val();
                var confirmPassword = $(this).val();
                
                if (confirmPassword.length > 0) {
                    if (password === confirmPassword) {
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                } else {
                    $(this).removeClass('is-valid is-invalid');
                }
            });
            
            $('input[name="password"]').on('input', function() {
                var password = $(this).val();
                var confirmPassword = $('input[name="password_confirm"]').val();
                
                if (confirmPassword.length > 0) {
                    if (password === confirmPassword) {
                        $('input[name="password_confirm"]').removeClass('is-invalid').addClass('is-valid');
                    } else {
                        $('input[name="password_confirm"]').removeClass('is-valid').addClass('is-invalid');
                    }
                }
            });
        });
    });

    // Handle Add User submit
    $('#addUserForm').on('submit', function(e) {
        e.preventDefault();
        
        // Check if passwords match
        var password = $('input[name="password"]').val();
        var passwordConfirm = $('input[name="password_confirm"]').val();
        
        if (password !== passwordConfirm) {
            alert('Error: Passwords do not match!');
            return;
        }
        
        var data = {};
        $(this).find('input,select').each(function() {
            if ($(this).attr('name') === 'roles') {
                data['roles'] = $(this).val() || [];
            } else if ($(this).attr('name') !== 'password_confirm') { // Don't send confirm password
                data[$(this).attr('name')] = $(this).val();
            }
        });
        
        $.ajax({
            url: '/admin/users/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // Edit User Modal: Populate form fields
    $(document).on('click', '.edit-user-btn', function() {
        var id = $(this).data('id');
        // Fetch user data from the server
        $.get('/admin/users/' + id, function(userData) {
            fetchRoles(function(roles) {
                var modal = $('#editUserModal');
                var form = modal.find('.modal-body');
                // Use userData.roles from the API, not from the table
                var userRoles = userData.roles || [];
                var rolesOptions = roles.map(r => 
                    `<option value='${r.name}' ${userRoles.includes(r.name) ? 'selected' : ''}>${r.name}</option>`
                ).join('');
                // Format dates for input fields
                var proEndDate = userData.pro_end_date ? new Date(userData.pro_end_date).toISOString().split('T')[0] : '';
                var lastLogin = userData.last_login ? new Date(userData.last_login).toLocaleString() : 'Never';
                var loginCount = userData.login_count || 0;
                var canceledAt = userData.canceled_at ? new Date(userData.canceled_at).toISOString().split('T')[0] : '';
                var custIdHtml = userData.cust_id ? `<a href='https://dashboard.stripe.com/customers/${userData.cust_id}' target='_blank' rel='noopener'>${userData.cust_id}</a>` : 'N/A';
                var formHtml = `
                    <input type='hidden' name='id' value='${id}'>
                    <input type='hidden' name='cust_id' value='${userData.cust_id || ''}'>
                    <input type='hidden' name='login_count' value='${loginCount}'>
                    <input type='hidden' name='last_login' value='${userData.last_login || ''}'>
                    <div class='mb-1 d-flex align-items-center'><label class='mb-0 small'>User ID:</label><span class='ms-2'>${id}</span></div>
                    <div class='mb-1 d-flex align-items-center'><label class='mb-0 small'>Customer ID:</label><span class='ms-2'>${custIdHtml}</span></div>
                    <div class='mb-1'><label class='small mb-1'>First Name</label><input name='first_name' class='form-control form-control-sm' value='${userData.first_name || ''}'></div>
                    <div class='mb-1'><label class='small mb-1'>Last Name</label><input name='last_name' class='form-control form-control-sm' value='${userData.last_name || ''}'></div>
                    <div class='mb-1'><label class='small mb-1'>Email</label><input name='email' type='email' class='form-control form-control-sm' value='${userData.email || ''}' required></div>
                    <div class='mb-1'>
                      <label class='small mb-1'>Password <small class='text-muted'>(optional)</small></label>
                      <input name='password' type='password' class='form-control form-control-sm' placeholder='Leave blank to keep current password' pattern='(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}' title='Min 8 chars, include upper/lower and a number'>
                      <div class='form-text small'>Min 8 characters with upper, lower, and a number.</div>
                    </div>
                    <div class='mb-1'>
                      <label class='small mb-1'>Confirm Password <small class='text-muted'>(optional)</small></label>
                      <input name='password_confirm' type='password' class='form-control form-control-sm' placeholder='Re-enter password'>
                    </div>
                    <div class='mb-1'><label class='small mb-1'>Pro End Date</label><input type='date' name='pro_end_date' class='form-control form-control-sm' value='${proEndDate}'></div>
                    <div class='mb-1'><label class='small mb-1'>Active</label><select name='active' class='form-select form-select-sm'><option value='1' ${userData.active ? 'selected' : ''}>Yes</option><option value='0' ${!userData.active ? 'selected' : ''}>No</option></select></div>
                    <div class='mb-1 d-flex align-items-center'><label class='mb-0 small'>Last Login:</label><span class='ms-2'>${lastLogin}</span></div>
                    <div class='mb-1 d-flex align-items-center'><label class='mb-0 small'>Login Count:</label><span class='ms-2'>${loginCount}</span></div>
                    <div class='mb-1'><label class='small mb-1'>Roles</label><select name='roles' class='form-select form-select-sm' multiple>${rolesOptions}</select></div>
                    <div class='mb-1'><label class='small mb-1'>Canceled At</label><input name='canceled_at' type='date' class='form-control form-control-sm' value='${canceledAt}'></div>
                    <div class='mb-1'><label class='small mb-1'>Cancel Reason</label><input name='cancellation_reason' class='form-control form-control-sm' value='${userData.cancellation_reason || ''}'></div>
                    <div class='mb-1'><label class='small mb-1'>Cancel Comment</label><textarea name='cancellation_comment' class='form-control form-control-sm' rows='2'>${userData.cancellation_comment || ''}</textarea></div>
                `;
                form.html(formHtml);
                modal.modal('show');
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            alert('Error loading user data. Please try again.');
        });
    });

    // Handle Edit User submit
    $('#editUserForm').on('submit', function(e) {
        e.preventDefault();
        var id = $(this).find('input[name="id"]').val();
        var data = {};
        $(this).find('input,select').each(function() {
            var name = $(this).attr('name');
            if (name === 'roles') {
                data['roles'] = $(this).val() || [];
            } else if (name !== 'id' && name !== 'login_count' && name !== 'last_login') {
                data[name] = $(this).val();
            }
        });
        // Client-side confirm password match, only if provided
        if (data.password || data.password_confirm) {
            if (data.password !== data.password_confirm) {
                alert('Passwords do not match.');
                return;
            }
        }
        delete data.password_confirm;
        // Check if Pro role is selected and Pro End Date is empty
        if (data.roles.includes('Pro') && !data.pro_end_date) {
            alert('Pro End Date is required when Pro role is selected.');
            return;
        }
        $.ajax({
            url: '/admin/users/edit/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // Handle Delete User
    $(document).on('click', '.delete-user-btn', function() {
            var id = $(this).data('id');
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to delete this user. This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
            $.ajax({
                    url: '/admin/users/' + id,
                method: 'DELETE',
                success: function(resp) {
                    location.reload();
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
                }
            });
        }
        });
    });

    // Bootstrap tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %} 