{% extends 'admin/master.html' %}

{% block body %}
            <!-- Messages Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span data-bs-toggle="tooltip" title="All messages in the system. Columns include name, email, subject, message, and actions to edit or delete.">Messages</span>
                        <small class="text-muted d-block">All timestamps shown in Pacific Time</small>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Bulk Actions Dropdown -->
                        <div class="dropdown" id="bulkActionsDropdown" style="display: none;">
                            <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="selectedCount">0</span> Selected
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="bulkDeleteBtn"><i class="fas fa-trash text-danger"></i> Delete Selected</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkMarkReadBtn"><i class="fas fa-check text-success"></i> Mark as Read</a></li>
                                <li><a class="dropdown-item disabled" href="#" id="bulkArchiveBtn"><i class="fas fa-archive text-info"></i> Archive <span class="badge bg-secondary">Soon</span></a></li>
                            </ul>
                        </div>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMessageModal">Add Message</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm" id="messages-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Type</th>
                                    <th>Subject</th>
                                    <th>Message</th>
                                    <th>Timestamp <small class="text-muted">(Pacific Time)</small></th>
                                    <th>Read</th>
                                    <th class="no-sort"></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reply Modal -->
            <div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form id="replyForm" class="compact-form">
                    <div class="modal-header">
                      <h5 class="modal-title">Reply to Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <input type="hidden" name="message_id" id="reply_message_id">
                      <div class="mb-2">
                        <label>To</label>
                        <input id="reply_to" name="to" class="form-control form-control-sm" type="email" required>
                      </div>
                      <div class="mb-2">
                        <label>Subject</label>
                        <input id="reply_subject" name="subject" class="form-control form-control-sm" required>
                      </div>
                      <div class="mb-2">
                        <label>Body</label>
                        <textarea id="reply_body" name="body" class="form-control form-control-sm" rows="6" required></textarea>
                      </div>
                    </div>
            <div class="modal-footer">
              <div class="w-100 d-grid modal-footer-grid">
                <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary btn-compact">Send</button>
              </div>
            </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Add Message Modal -->
            <div class="modal fade" id="addMessageModal" tabindex="-1" aria-labelledby="addMessageModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="addMessageForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addMessageModalLabel">Add Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS or rendered here -->
                    </div>
                    <div class="modal-footer">
                      <div class="w-100 d-grid modal-footer-grid">
                      <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success btn-compact">Add Message</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- View Message Modal -->
            <div class="modal fade" id="viewMessageModal" tabindex="-1" aria-labelledby="viewMessageModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="viewMessageModalLabel">View Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <!-- Message content will be injected by JS -->
                  </div>
                  <div class="modal-footer">
                    <div class="w-100 d-grid modal-footer-grid">
                      <button type="button" class="btn btn-outline-primary btn-compact" id="viewMessageReplyBtn">Reply</button>
                      <button type="button" class="btn btn-primary btn-compact" id="viewMessageEditBtn">Edit</button>
                      <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Edit Message Modal -->
            <div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="editMessageForm" class="compact-form">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editMessageModalLabel">Edit Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS -->
                    </div>
                    <div class="modal-footer">
                      <div class="w-100 d-grid modal-footer-grid">
                        <button type="button" class="btn btn-outline-primary btn-compact" id="editMessageReplyBtn">Reply</button>
                        <button type="submit" class="btn btn-primary btn-compact">Save Changes</button>
                        <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger btn-compact" id="editMessageDeleteBtn">Delete</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
{% endblock %}

{% block extra_scripts %}
<!-- Custom CSS for bulk actions -->
<style>
    #bulkActionsDropdown {
        transition: opacity 0.3s ease;
    }
    
    #bulkActionsDropdown .dropdown-menu {
        min-width: 200px;
    }
    
    #bulkActionsDropdown .dropdown-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #bulkActionsDropdown .dropdown-item i {
        width: 16px;
        margin-right: 8px;
    }
    
    .message-checkbox {
        cursor: pointer;
    }
    
    #selectAll {
        cursor: pointer;
    }
    
    /* Ensure checkbox column is properly aligned */
    #messages-table tbody td:first-child {
        text-align: center;
        vertical-align: middle;
    }
    
    #messages-table thead th:first-child {
        text-align: center;
        vertical-align: middle;
    }

    /* Compact form styles */
    .compact-form .form-control,
    .compact-form .form-select {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
    }
    .compact-form .mb-3 { margin-bottom: 0.5rem !important; }
    .compact-form .mb-2 { margin-bottom: 0.4rem !important; }
    .compact-form label { margin-bottom: 0.15rem; font-size: 0.9rem; }
    
    /* Ultra-compact form styles for table view */
    .compact-form .form-control-sm,
    .compact-form .form-select-sm {
        padding: 0.15rem 0.3rem;
        font-size: 0.8rem;
        height: auto;
        min-height: 28px;
    }
    .compact-form .mb-2 { margin-bottom: 0.25rem !important; }
    .compact-form .mb-1 { margin-bottom: 0.15rem !important; }
    .compact-form label { margin-bottom: 0.1rem; font-size: 0.8rem; }

    /* Reduce vertical padding in modals to decrease overall height */
    #editMessageModal .modal-header,
    #editMessageModal .modal-footer,
    #replyModal .modal-header,
    #replyModal .modal-footer,
    #addMessageModal .modal-header,
    #addMessageModal .modal-footer {
        padding-top: 0.4rem;
        padding-bottom: 0.4rem;
    }
    #editMessageModal .modal-body,
    #replyModal .modal-body,
    #addMessageModal .modal-body {
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
    }
    
    /* Extra compact for edit modal */
    #editMessageModal .modal-body {
        padding: 0.4rem 1rem;
    }
    #editMessageModal .modal-title,
    #replyModal .modal-title,
    #addMessageModal .modal-title { font-size: 1rem; }

    /* Footer grid for narrower buttons (2 columns on sm+, 1 col on xs) */
    .modal-footer-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
    }
    @media (min-width: 576px) {
        .modal-footer-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 768px) {
        .modal-footer-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .btn-compact {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        white-space: nowrap;
    }
</style>

<!-- jQuery (must be loaded before DataTables and custom JS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#messages-table').DataTable({
        serverSide: true,
        processing: true,
        paging: true,
        searching: true,
        info: true,
        order: [],
        responsive: true,
        fixedHeader: false,
        scrollY: '400px',
        scrollCollapse: true,
        lengthMenu: [[25, 50, 100, 250, 500], [25, 50, 100, 250, 500]],
        pageLength: 25,
        language: { lengthMenu: 'Show _MENU_ entries per page' },
        deferRender: true,
        ajax: {
            url: '/admin/messages/data',
            type: 'GET',
            error: function(xhr, error, thrown) {
                if (xhr.status === 429) {
                    // Rate limit exceeded - show user-friendly message
                    setTimeout(function() {
                        $('#messages-table').DataTable().ajax.reload(null, false);
                    }, 1000);
    
                } else {
                    console.error('DataTables error:', error, thrown);
                }
            }
        },
        columns: [
            { 
                data: 'id',
                render: function(data, type, row) {
                    return '<input type="checkbox" class="form-check-input message-checkbox" data-id="' + data + '">';
                },
                orderable: false,
                searchable: false,
                width: '40px'
            },
            { data: 'id' },
            { data: 'email' },
            { 
                data: 'communication_type',
                render: function(data, type, row) {
                    let typeDisplay = data || 'N/A';
                    if (row.form_type) {
                        typeDisplay += ` (${row.form_type})`;
                    }
                    return typeDisplay;
                }
            },
            { data: 'subject' },
            { data: 'body' },
            { data: 'timestamp' },
            { data: 'read' },
             { data: 'actions', orderable: false, searchable: false }
        ]
    });

    // Add Message Modal: Render form fields
    $('#addMessageModal').on('show.bs.modal', function() {
        var form = $(this).find('.modal-body');
        form.html(`
            <div class='mb-3'><label>Sender ID</label><input name='sender_id' type='number' class='form-control'></div>
            <div class='mb-3'><label>Type</label><input name='communication_type' class='form-control' required></div>
            <div class='mb-3'><label>Subject</label><input name='subject' class='form-control' required></div>
            <div class='mb-3'><label>Message</label><textarea name='body' class='form-control' required></textarea></div>
            <div class='mb-3'><label>Reported Address</label><input name='reported_address' class='form-control'></div>
            <div class='mb-3'><label>Reported Phone</label><input name='reported_phone' class='form-control'></div>
            <div class='mb-3'><label>Reported Website</label><input name='reported_website' class='form-control'></div>
            <div class='mb-3'><label>Reported Hours</label><input name='reported_hours' class='form-control'></div>
            <div class='mb-3'><label>Reported Out of Business</label><select name='out_of_business' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
            <div class='mb-3'><label>Is New Location</label><select name='is_new_location' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
            <div class='mb-3'><label>Admin Report</label><select name='is_admin_report' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
            <div class='mb-3'><label>Form Type</label><select name='form_type' class='form-control'><option value=''>None</option><option value='add_new'>Add New Location</option><option value='correct_existing'>Correct Existing Location</option></select></div>
            <div class='mb-3'><label>Win Type</label><input name='win_type' class='form-control'></div>
            <div class='mb-3'><label>Location Used</label><input name='location_used' class='form-control'></div>
            <div class='mb-3'><label>Cards Found</label><input name='cards_found' class='form-control'></div>
            <div class='mb-3'><label>Time Saved</label><input name='time_saved' class='form-control'></div>
            <div class='mb-3'><label>Money Saved</label><input name='money_saved' class='form-control'></div>
            <div class='mb-3'><label>Allow Feature</label><select name='allow_feature' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
            <div class='mb-3'><label>Email</label><input name='email' type='email' class='form-control'></div>
            <div class='mb-3'><label>Read</label><select name='read' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
        `);
    });

    // Handle Add Message submit
    $('#addMessageForm').on('submit', function(e) {
        e.preventDefault();
        var data = {};
        $(this).find('input, textarea, select').each(function() {
            data[$(this).attr('name')] = $(this).val();
        });
        $.ajax({
            url: '/admin/messages/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // Reply button
    $(document).on('click', '.reply-message-btn', function() {
        var id = $(this).data('id');
        $.get('/admin/messages/' + id, function(data) {
            $('#reply_message_id').val(data.id);
            $('#reply_to').val(data.email || data.address || '');
            $('#reply_subject').val('Re: ' + (data.subject || 'Message'));
            // Keep reply body clean; do NOT inject original message here
            $('#reply_body').val('');
            $('#replyModal').modal('show');
        });
    });

    $('#replyForm').on('submit', function(e) {
        e.preventDefault();
        const payload = {
            message_id: $('#reply_message_id').val(),
            to: $('#reply_to').val(),
            subject: $('#reply_subject').val(),
            body: $('#reply_body').val()
        };
        $.ajax({
            url: '/admin/messages/reply',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload)
        }).done(function(){
            $('#replyModal').modal('hide');
            Swal.fire({ icon: 'success', title: 'Sent' });
        }).fail(function(xhr){
            Swal.fire({ icon: 'error', title: 'Error', text: xhr.responseText || 'Failed to send' });
        });
    });

    // View Message Modal: Populate content using AJAX
    $(document).on('click', '.view-message-btn', function() {
        var id = $(this).data('id');
        var modal = $('#viewMessageModal');
        var body = modal.find('.modal-body');
        
        // Mark message as read when viewing
        $.ajax({
            url: '/admin/messages/' + id + '/mark-read',
            method: 'POST',
            success: function() {
                // Update the read status in the table without reloading
                var table = $('#messages-table').DataTable();
                var rowIndex = table.rows().nodes().to$().filter(`[data-id="${id}"]`).index();
                if (rowIndex >= 0) {
                    var row = table.row(rowIndex);
                    if (row.length) {
                        row.node().cells[7].textContent = 'Yes'; // Update the Read column
                    }
                }
            }
        });
        
        $.get('/admin/messages/' + id, function(data) {
            body.html(`
                <div class="row">
                    <div class="col-md-6">
                        <div class='mb-3'><strong>Sender ID:</strong> ${data.sender_id || 'N/A'}</div>
                        <div class='mb-3'><strong>Type:</strong> ${data.communication_type || 'N/A'}</div>
                        <div class='mb-3'><strong>Form Type:</strong> ${data.form_type || 'N/A'}</div>
                        <div class='mb-3'><strong>Subject:</strong> ${data.subject || 'N/A'}</div>
                        <div class='mb-3'><strong>Name:</strong> ${data.name || 'N/A'}</div>
                        <div class='mb-3'><strong>Email:</strong> ${data.address || 'N/A'}</div>
                        <div class='mb-3'><strong>Timestamp:</strong> ${data.timestamp ? data.timestamp.replace("T", " ").slice(0, 16) : 'N/A'}</div>
                        <div class='mb-3'><strong>Read:</strong> ${data.read ? 'Yes' : 'No'}</div>
                    </div>
                    <div class="col-md-6">
                        <div class='mb-3'><strong>Reported Address:</strong> ${data.reported_address || 'N/A'}</div>
                        <div class='mb-3'><strong>Reported Phone:</strong> ${data.reported_phone || 'N/A'}</div>
                        <div class='mb-3'><strong>Reported Website:</strong> ${data.reported_website || 'N/A'}</div>
                        <div class='mb-3'><strong>Reported Hours:</strong> ${data.reported_hours || 'N/A'}</div>
                        <div class='mb-3'><strong>Reported Out of Business:</strong> ${data.out_of_business ? 'Yes' : 'No'}</div>
                        <div class='mb-3'><strong>Admin Report:</strong> ${data.is_admin_report ? 'Yes' : 'No'}</div>
                        <div class='mb-3'><strong>Win Type:</strong> ${data.win_type || 'N/A'}</div>
                        <div class='mb-3'><strong>Location Used:</strong> ${data.location_used || 'N/A'}</div>
                        <div class='mb-3'><strong>Cards Found:</strong> ${data.cards_found || 'N/A'}</div>
                        <div class='mb-3'><strong>Time Saved:</strong> ${data.time_saved || 'N/A'}</div>
                        <div class='mb-3'><strong>Money Saved:</strong> ${data.money_saved || 'N/A'}</div>
                        <div class='mb-3'><strong>Allow Feature:</strong> ${data.allow_feature ? 'Yes' : 'No'}</div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class='mb-3'><strong>Message:</strong></div>
                        <div class="border p-3 bg-light rounded">${data.body || 'N/A'}</div>
                    </div>
                </div>
            `);
            
            // Remove aria-hidden and show modal with proper focus management
            modal.removeAttr('aria-hidden').modal('show');
            
            // Handle focus properly to avoid aria-hidden conflicts
            modal.on('shown.bs.modal', function() {
                // Remove focus from any focused elements to prevent aria-hidden conflict
                $(document.activeElement).blur();
            });
        }).fail(function() {
            alert('Error loading message data.');
        });
    });

    // Edit Message Modal: Populate form fields using AJAX
    $(document).on('click', '.edit-message-btn', function() {
        var id = $(this).data('id');
        var modal = $('#editMessageModal');
        var form = modal.find('.modal-body');
        
        // Mark message as read when editing
        $.ajax({
            url: '/admin/messages/' + id + '/mark-read',
            method: 'POST',
            success: function() {
                // Update the read status in the table without reloading
                var table = $('#messages-table').DataTable();
                var rowIndex = table.rows().nodes().to$().filter(`[data-id="${id}"]`).index();
                if (rowIndex >= 0) {
                    var row = table.row(rowIndex);
                    if (row.length) {
                        row.node().cells[7].textContent = 'Yes'; // Update the Read column
                    }
                }
            }
        });
        
        $.get('/admin/messages/' + id, function(data) {
            form.html(`
                <input type='hidden' name='id' value='${data.id}'>
                <div class='mb-1'><label>Sender ID</label><input name='sender_id' type='number' class='form-control form-control-sm' value='${data.sender_id || ''}' readonly></div>
                <div class='mb-1'><label>Type</label><input name='communication_type' class='form-control form-control-sm' value='${data.communication_type || ''}' required></div>
                <div class='mb-1'><label>Subject</label><input name='subject' class='form-control form-control-sm' value='${data.subject || ''}' required></div>
                <div class='mb-1'><label>Message</label><textarea name='body' class='form-control form-control-sm' rows='4' required>${data.body || ''}</textarea></div>
                <div class='mb-1'><label>Reported Address</label><input name='reported_address' class='form-control form-control-sm' value='${data.reported_address || ''}'></div>
                <div class='mb-1'><label>Reported Phone</label><input name='reported_phone' class='form-control form-control-sm' value='${data.reported_phone || ''}'></div>
                <div class='mb-1'><label>Reported Website</label><input name='reported_website' class='form-control form-control-sm' value='${data.reported_website || ''}'></div>
                <div class='mb-1'><label>Reported Hours</label><input name='reported_hours' class='form-control form-control-sm' value='${data.reported_hours || ''}'></div>
                <div class='mb-1'><label>Reported Out of Business</label><select name='out_of_business' class='form-control form-control-sm'>
                    <option value='false' ${!data.out_of_business ? 'selected' : ''}>No</option>
                    <option value='true' ${data.out_of_business ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-1'><label>Is New Location</label><select name='is_new_location' class='form-control form-control-sm'>
                    <option value='false' ${!data.is_new_location ? 'selected' : ''}>No</option>
                    <option value='true' ${data.is_new_location ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-1'><label>Admin Report</label><select name='is_admin_report' class='form-control form-control-sm'>
                    <option value='false' ${!data.is_admin_report ? 'selected' : ''}>No</option>
                    <option value='true' ${data.is_admin_report ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-1'><label>Form Type</label><select name='form_type' class='form-control form-control-sm'>
                    <option value='' ${!data.form_type ? 'selected' : ''}>None</option>
                    <option value='add_new' ${data.form_type === 'add_new' ? 'selected' : ''}>Add New Location</option>
                    <option value='correct_existing' ${data.form_type === 'correct_existing' ? 'selected' : ''}>Correct Existing Location</option>
                </select></div>
                <div class='mb-1'><label>Win Type</label><input name='win_type' class='form-control form-control-sm' value='${data.win_type || ''}'></div>
                <div class='mb-1'><label>Location Used</label><input name='location_used' class='form-control form-control-sm' value='${data.location_used || ''}'></div>
                <div class='mb-1'><label>Cards Found</label><input name='cards_found' class='form-control form-control-sm' value='${data.cards_found || ''}'></div>
                <div class='mb-1'><label>Time Saved</label><input name='time_saved' class='form-control form-control-sm' value='${data.time_saved || ''}'></div>
                <div class='mb-1'><label>Money Saved</label><input name='money_saved' class='form-control form-control-sm' value='${data.money_saved || ''}'></div>
                <div class='mb-1'><label>Allow Feature</label><select name='allow_feature' class='form-control form-control-sm'>
                    <option value='false' ${!data.allow_feature ? 'selected' : ''}>No</option>
                    <option value='true' ${data.allow_feature ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-1'><label>Timestamp</label><input class='form-control form-control-sm' value='${data.timestamp ? data.timestamp.replace("T", " ").slice(0, 16) : ''}' readonly></div>
                <div class='mb-1'><label>Read</label><select name='read' class='form-control form-control-sm'>
                    <option value='false' ${!data.read ? 'selected' : ''}>No</option>
                    <option value='true' ${data.read ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-1'><label>Name</label><input name='name' class='form-control form-control-sm' value='${data.name || ''}'></div>
                <div class='mb-1'><label>Email Address</label><input name='address' class='form-control form-control-sm' value='${data.address || ''}'></div>
            `);
            modal.modal('show');
        }).fail(function() {
            alert('Error loading message data.');
        });
    });

    // Handle Edit Message submit
    $('#editMessageForm').on('submit', function(e) {
        e.preventDefault();
        var id = $(this).find('input[name="id"]').val();
        var data = {};
        $(this).find('input, textarea, select').each(function() {
            if ($(this).attr('name') !== 'id')
                data[$(this).attr('name')] = $(this).val();
        });
        $.ajax({
            url: '/admin/messages/edit/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                // After saving, offer to reply
                Swal.fire({
                    title: 'Changes Saved',
                    text: 'Do you want to reply to this message now?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Reply',
                    cancelButtonText: 'Close'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const email = data.address || '';
                        const subject = data.subject ? ('Re: ' + data.subject) : 'Re: Message';
                        $('#reply_message_id').val(id);
                        $('#reply_to').val(email);
                        $('#reply_subject').val(subject);
                        $('#reply_body').val('');
                        $('#editMessageModal').modal('hide');
                        $('#replyModal').modal('show');
                    } else {
                        location.reload();
                    }
                });
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // View modal footer: Edit button
    $(document).on('click', '#viewMessageEditBtn', function() {
        var modal = $('#viewMessageModal');
        var id = modal.find('.modal-body').find('[data-id]').attr('data-id') || 
                 modal.find('.modal-body').text().match(/Sender ID:\s*(\d+)/)?.[1];
        if (id) {
            modal.modal('hide');
            // Trigger the edit button click for this message
            $(`.edit-message-btn[data-id="${id}"]`).click();
        }
    });

    // Edit modal footer: Reply button
    $(document).on('click', '#editMessageReplyBtn', function() {
        var modal = $('#editMessageModal');
        var id = modal.find('input[name="id"]').val();
        var email = modal.find('input[name="address"]').val() || '';
        var subject = modal.find('input[name="subject"]').val() || 'Message';
        $('#reply_message_id').val(id);
        $('#reply_to').val(email);
        $('#reply_subject').val('Re: ' + subject);
        $('#reply_body').val('');
        $('#editMessageModal').modal('hide');
        $('#replyModal').modal('show');
    });

    // Edit modal footer: Delete button (with confirmation)
    $(document).on('click', '#editMessageDeleteBtn', function() {
        var modal = $('#editMessageModal');
        var id = modal.find('input[name="id"]').val();
        if (!id) { return; }
        Swal.fire({
            title: 'Delete this message?',
            text: 'This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/messages/' + id,
                    method: 'DELETE'
                }).done(function() {
                    $('#editMessageModal').modal('hide');
                    Swal.fire({ icon: 'success', title: 'Deleted' }).then(() => location.reload());
                }).fail(function(xhr){
                    Swal.fire({ icon: 'error', title: 'Error', text: xhr.responseText || 'Failed to delete' });
                });
            }
        });
    });

    // Handle Delete Message
    $(document).on('click', '.delete-message-btn', function() {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to delete this message. This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
        var id = $(this).data('id');
        $.ajax({
            url: '/admin/messages/' + id,
            method: 'DELETE',
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error deleting message: ' + (xhr.responseJSON?.errors || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
            }
        });
    });

    // Bootstrap tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // ===== BULK ACTIONS FUNCTIONALITY =====
    
    // Handle Select All checkbox
    $('#selectAll').on('change', function() {
        var isChecked = $(this).is(':checked');
        $('.message-checkbox').prop('checked', isChecked);
        updateBulkActionsVisibility();
    });
    
    // Handle individual checkbox changes
    $(document).on('change', '.message-checkbox', function() {
        var totalCheckboxes = $('.message-checkbox').length;
        var checkedCheckboxes = $('.message-checkbox:checked').length;
        
        // Update "Select All" checkbox state
        $('#selectAll').prop('checked', checkedCheckboxes === totalCheckboxes);
        $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
        
        updateBulkActionsVisibility();
    });
    
    // Update bulk actions dropdown visibility and count
    function updateBulkActionsVisibility() {
        var checkedCount = $('.message-checkbox:checked').length;
        $('#selectedCount').text(checkedCount);
        
        if (checkedCount > 0) {
            $('#bulkActionsDropdown').show();
        } else {
            $('#bulkActionsDropdown').hide();
        }
    }
    
    // Handle bulk delete
    $('#bulkDeleteBtn').on('click', function(e) {
        e.preventDefault();
        var selectedIds = [];
        $('.message-checkbox:checked').each(function() {
            selectedIds.push($(this).data('id'));
        });
        
        if (selectedIds.length === 0) {
            Swal.fire({
                title: 'No Messages Selected',
                text: 'Please select at least one message to delete.',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to delete ${selectedIds.length} message(s). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete them!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performBulkDelete(selectedIds);
            }
        });
    });
    
    // Perform bulk delete operation
    function performBulkDelete(ids) {
        $.ajax({
            url: '/admin/messages/bulk-delete',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: `${response.deleted_count} message(s) deleted successfully.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    $('#messages-table').DataTable().ajax.reload();
                    $('#selectAll').prop('checked', false);
                    updateBulkActionsVisibility();
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error deleting messages: ' + (xhr.responseJSON?.message || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }
    
    // Handle bulk mark as read
    $('#bulkMarkReadBtn').on('click', function(e) {
        e.preventDefault();
        var selectedIds = [];
        $('.message-checkbox:checked').each(function() {
            selectedIds.push($(this).data('id'));
        });
        
        if (selectedIds.length === 0) {
            Swal.fire({
                title: 'No Messages Selected',
                text: 'Please select at least one message to mark as read.',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        Swal.fire({
            title: 'Mark as Read?',
            text: `Mark ${selectedIds.length} message(s) as read?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, mark as read!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performBulkMarkRead(selectedIds);
            }
        });
    });
    
    // Perform bulk mark as read operation
    function performBulkMarkRead(ids) {
        $.ajax({
            url: '/admin/messages/bulk-mark-read',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: `${response.updated_count} message(s) marked as read.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    $('#messages-table').DataTable().ajax.reload();
                    $('#selectAll').prop('checked', false);
                    updateBulkActionsVisibility();
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error marking messages as read: ' + (xhr.responseJSON?.message || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }
    
    // Handle bulk archive (placeholder)
    $('#bulkArchiveBtn').on('click', function(e) {
        e.preventDefault();
        Swal.fire({
            title: 'Coming Soon',
            text: 'Bulk archive functionality will be available soon.',
            icon: 'info',
            confirmButtonText: 'OK'
        });
    });
    
    // Reset checkboxes when table reloads
    $('#messages-table').on('draw.dt', function() {
        $('#selectAll').prop('checked', false);
        updateBulkActionsVisibility();
    });
});
</script>
{% endblock %}
<!-- touch --> 