{% extends 'admin/master.html' %}

{% block body %}
            <!-- Messages Table -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <span data-bs-toggle="tooltip" title="All messages in the system. Columns include name, email, subject, message, and actions to edit or delete.">Messages</span>
                        <small class="text-muted d-block">All timestamps shown in Pacific Time</small>
                    </div>
                    <div class="d-flex gap-2">
                        <!-- Bulk Actions Dropdown -->
                        <div class="dropdown" id="bulkActionsDropdown" style="display: none;">
                            <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <span id="selectedCount">0</span> Selected
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="bulkDeleteBtn"><i class="fas fa-trash text-danger"></i> Delete Selected</a></li>
                                <li><a class="dropdown-item" href="#" id="bulkMarkReadBtn"><i class="fas fa-check text-success"></i> Mark as Read</a></li>
                                <li><a class="dropdown-item disabled" href="#" id="bulkArchiveBtn"><i class="fas fa-archive text-info"></i> Archive <span class="badge bg-secondary">Soon</span></a></li>
                            </ul>
                        </div>
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMessageModal">Add Message</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm" id="messages-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Type</th>
                                    <th>Subject</th>
                                    <th>Message</th>
                                    <th>Timestamp <small class="text-muted">(Pacific Time)</small></th>
                                    <th>Read</th>
                                    <th class="no-sort"></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reply Modal -->
            <div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form id="replyForm" class="compact-form">
                    <div class="modal-header">
                      <h5 class="modal-title">Reply to Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <input type="hidden" name="message_id" id="reply_message_id">
                      <div class="mb-2">
                        <label>To</label>
                        <input id="reply_to" name="to" class="form-control form-control-sm" type="email" required>
                      </div>
                      <div class="mb-2">
                        <label>Subject</label>
                        <input id="reply_subject" name="subject" class="form-control form-control-sm" required>
                      </div>
                      <div class="mb-2">
                        <label>Body</label>
                        <textarea id="reply_body" name="body" class="form-control form-control-sm" rows="6" required></textarea>
                      </div>
                    </div>
            <div class="modal-footer">
              <div class="w-100 d-grid modal-footer-grid">
                <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary btn-compact">Send</button>
              </div>
            </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Add Message Modal -->
            <div class="modal fade" id="addMessageModal" tabindex="-1" aria-labelledby="addMessageModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="addMessageForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addMessageModalLabel">Add Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS or rendered here -->
                    </div>
                    <div class="modal-footer">
                      <div class="w-100 d-grid modal-footer-grid">
                      <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success btn-compact">Add Message</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Edit Message Modal -->
            <div class="modal fade" id="editMessageModal" tabindex="-1" aria-labelledby="editMessageModalLabel" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="editMessageForm" class="compact-form">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editMessageModalLabel">Edit Message</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Form fields will be injected by JS -->
                    </div>
                    <div class="modal-footer">
                      <div class="w-100 d-grid modal-footer-grid">
                        <button type="button" class="btn btn-outline-primary btn-compact" id="editMessageReplyBtn">Reply</button>
                        <button type="submit" class="btn btn-primary btn-compact">Save Changes</button>
                        <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger btn-compact" id="editMessageDeleteBtn">Delete</button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
{% endblock %}

{% block extra_scripts %}
<!-- Custom CSS for bulk actions -->
<style>
    #bulkActionsDropdown {
        transition: opacity 0.3s ease;
    }
    
    #bulkActionsDropdown .dropdown-menu {
        min-width: 200px;
    }
    
    #bulkActionsDropdown .dropdown-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    #bulkActionsDropdown .dropdown-item i {
        width: 16px;
        margin-right: 8px;
    }
    
    .message-checkbox {
        cursor: pointer;
    }
    
    #selectAll {
        cursor: pointer;
    }
    
    /* Ensure checkbox column is properly aligned */
    #messages-table tbody td:first-child {
        text-align: center;
        vertical-align: middle;
    }
    
    #messages-table thead th:first-child {
        text-align: center;
        vertical-align: middle;
    }

    /* Compact form styles */
    .compact-form .form-control,
    .compact-form .form-select {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
    }
    .compact-form .mb-3 { margin-bottom: 0.5rem !important; }
    .compact-form .mb-2 { margin-bottom: 0.4rem !important; }
    .compact-form label { margin-bottom: 0.15rem; font-size: 0.9rem; }

    /* Reduce vertical padding in modals to decrease overall height */
    #editMessageModal .modal-header,
    #editMessageModal .modal-footer,
    #replyModal .modal-header,
    #replyModal .modal-footer,
    #addMessageModal .modal-header,
    #addMessageModal .modal-footer {
        padding-top: 0.4rem;
        padding-bottom: 0.4rem;
    }
    #editMessageModal .modal-body,
    #replyModal .modal-body,
    #addMessageModal .modal-body {
        padding-top: 0.6rem;
        padding-bottom: 0.6rem;
    }
    #editMessageModal .modal-title,
    #replyModal .modal-title,
    #addMessageModal .modal-title { font-size: 1rem; }

    /* Footer grid for narrower buttons (2 columns on sm+, 1 col on xs) */
    .modal-footer-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.5rem;
    }
    @media (min-width: 576px) {
        .modal-footer-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 768px) {
        .modal-footer-grid { grid-template-columns: repeat(4, 1fr); }
    }

    .btn-compact {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
        white-space: nowrap;
    }
</style>

<!-- jQuery (must be loaded before DataTables and custom JS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#messages-table').DataTable({
        serverSide: true,
        processing: true,
        paging: true,
        searching: true,
        info: true,
        order: [],
        responsive: true,
        fixedHeader: false,
        scrollY: '400px',
        scrollCollapse: true,
        lengthMenu: [[25, 50, 100, 250, 500], [25, 50, 100, 250, 500]],
        pageLength: 25,
        language: { lengthMenu: 'Show _MENU_ entries per page' },
        deferRender: true,
        ajax: {
            url: '/admin/messages/data',
            type: 'GET',
            error: function(xhr, error, thrown) {
                if (xhr.status === 429) {
                    // Rate limit exceeded - show user-friendly message
                    setTimeout(function() {
                        $('#messages-table').DataTable().ajax.reload(null, false);
                    }, 1000);
    
                } else {
                    console.error('DataTables error:', error, thrown);
                }
            }
        },
        columns: [
            { 
                data: 'id',
                render: function(data, type, row) {
                    return '<input type="checkbox" class="form-check-input message-checkbox" data-id="' + data + '">';
                },
                orderable: false,
                searchable: false,
                width: '40px'
            },
            { data: 'id' },
            { data: 'email' },
            { data: 'communication_type' },
            { data: 'subject' },
            { data: 'body' },
            { data: 'timestamp' },
            { data: 'read' },
             { data: 'actions', orderable: false, searchable: false }
        ]
    });

    // Add Message Modal: Render form fields
    $('#addMessageModal').on('show.bs.modal', function() {
        var form = $(this).find('.modal-body');
        form.html(`
            <div class='mb-3'><label>Sender ID</label><input name='sender_id' type='number' class='form-control'></div>
            <div class='mb-3'><label>Type</label><input name='communication_type' class='form-control' required></div>
            <div class='mb-3'><label>Subject</label><input name='subject' class='form-control' required></div>
            <div class='mb-3'><label>Message</label><textarea name='body' class='form-control' required></textarea></div>
            <div class='mb-3'><label>Email</label><input name='email' type='email' class='form-control'></div>
            <div class='mb-3'><label>Read</label><select name='read' class='form-control'><option value='false'>No</option><option value='true'>Yes</option></select></div>
        `);
    });

    // Handle Add Message submit
    $('#addMessageForm').on('submit', function(e) {
        e.preventDefault();
        var data = {};
        $(this).find('input, textarea, select').each(function() {
            data[$(this).attr('name')] = $(this).val();
        });
        $.ajax({
            url: '/admin/messages/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // Reply button
    $(document).on('click', '.reply-message-btn', function() {
        var id = $(this).data('id');
        $.get('/admin/messages/' + id, function(data) {
            $('#reply_message_id').val(data.id);
            $('#reply_to').val(data.email || data.address || '');
            $('#reply_subject').val('Re: ' + (data.subject || 'Message'));
            // Keep reply body clean; do NOT inject original message here
            $('#reply_body').val('');
            $('#replyModal').modal('show');
        });
    });

    $('#replyForm').on('submit', function(e) {
        e.preventDefault();
        const payload = {
            message_id: $('#reply_message_id').val(),
            to: $('#reply_to').val(),
            subject: $('#reply_subject').val(),
            body: $('#reply_body').val()
        };
        $.ajax({
            url: '/admin/messages/reply',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(payload)
        }).done(function(){
            $('#replyModal').modal('hide');
            Swal.fire({ icon: 'success', title: 'Sent' });
        }).fail(function(xhr){
            Swal.fire({ icon: 'error', title: 'Error', text: xhr.responseText || 'Failed to send' });
        });
    });

    // Edit Message Modal: Populate form fields using AJAX
    $(document).on('click', '.edit-message-btn', function() {
        var id = $(this).data('id');
        var modal = $('#editMessageModal');
        var form = modal.find('.modal-body');
        $.get('/admin/messages/' + id, function(data) {
            form.html(`
                <input type='hidden' name='id' value='${data.id}'>
                <div class='mb-2'><label>Sender ID</label><input name='sender_id' type='number' class='form-control form-control-sm' value='${data.sender_id || ''}' readonly></div>
                <div class='mb-2'><label>Type</label><input name='communication_type' class='form-control form-control-sm' value='${data.communication_type || ''}' required></div>
                <div class='mb-2'><label>Subject</label><input name='subject' class='form-control form-control-sm' value='${data.subject || ''}' required></div>
                <div class='mb-2'><label>Message</label><textarea name='body' class='form-control form-control-sm' rows='5' required>${data.body || ''}</textarea></div>
                <div class='mb-2'><label>Reported Address</label><input name='reported_address' class='form-control form-control-sm' value='${data.reported_address || ''}'></div>
                <div class='mb-2'><label>Reported Phone</label><input name='reported_phone' class='form-control form-control-sm' value='${data.reported_phone || ''}'></div>
                <div class='mb-2'><label>Reported Website</label><input name='reported_website' class='form-control form-control-sm' value='${data.reported_website || ''}'></div>
                <div class='mb-2'><label>Reported Hours</label><input name='reported_hours' class='form-control form-control-sm' value='${data.reported_hours || ''}'></div>
                <div class='mb-2'><label>Timestamp</label><input class='form-control form-control-sm' value='${data.timestamp ? data.timestamp.replace("T", " ").slice(0, 16) : ''}' readonly></div>
                <div class='mb-2'><label>Read</label><select name='read' class='form-control form-control-sm'>
                    <option value='false' ${!data.read ? 'selected' : ''}>No</option>
                    <option value='true' ${data.read ? 'selected' : ''}>Yes</option>
                </select></div>
                <div class='mb-2'><label>Name</label><input name='name' class='form-control form-control-sm' value='${data.name || ''}'></div>
                <div class='mb-2'><label>Email Address</label><input name='address' class='form-control form-control-sm' value='${data.address || ''}'></div>
            `);
            modal.modal('show');
        }).fail(function() {
            alert('Error loading message data.');
        });
    });

    // Handle Edit Message submit
    $('#editMessageForm').on('submit', function(e) {
        e.preventDefault();
        var id = $(this).find('input[name="id"]').val();
        var data = {};
        $(this).find('input, textarea, select').each(function() {
            if ($(this).attr('name') !== 'id')
                data[$(this).attr('name')] = $(this).val();
        });
        $.ajax({
            url: '/admin/messages/edit/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                // After saving, offer to reply
                Swal.fire({
                    title: 'Changes Saved',
                    text: 'Do you want to reply to this message now?',
                    icon: 'success',
                    showCancelButton: true,
                    confirmButtonText: 'Reply',
                    cancelButtonText: 'Close'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const email = data.address || '';
                        const subject = data.subject ? ('Re: ' + data.subject) : 'Re: Message';
                        $('#reply_message_id').val(id);
                        $('#reply_to').val(email);
                        $('#reply_subject').val(subject);
                        $('#reply_body').val('');
                        $('#editMessageModal').modal('hide');
                        $('#replyModal').modal('show');
                    } else {
                        location.reload();
                    }
                });
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.errors ? JSON.stringify(xhr.responseJSON.errors) : 'Unknown error'));
            }
        });
    });

    // Edit modal footer: Reply button
    $(document).on('click', '#editMessageReplyBtn', function() {
        var modal = $('#editMessageModal');
        var id = modal.find('input[name="id"]').val();
        var email = modal.find('input[name="address"]').val() || '';
        var subject = modal.find('input[name="subject"]').val() || 'Message';
        $('#reply_message_id').val(id);
        $('#reply_to').val(email);
        $('#reply_subject').val('Re: ' + subject);
        $('#reply_body').val('');
        $('#editMessageModal').modal('hide');
        $('#replyModal').modal('show');
    });

    // Edit modal footer: Delete button (with confirmation)
    $(document).on('click', '#editMessageDeleteBtn', function() {
        var modal = $('#editMessageModal');
        var id = modal.find('input[name="id"]').val();
        if (!id) { return; }
        Swal.fire({
            title: 'Delete this message?',
            text: 'This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/messages/' + id,
                    method: 'DELETE'
                }).done(function() {
                    $('#editMessageModal').modal('hide');
                    Swal.fire({ icon: 'success', title: 'Deleted' }).then(() => location.reload());
                }).fail(function(xhr){
                    Swal.fire({ icon: 'error', title: 'Error', text: xhr.responseText || 'Failed to delete' });
                });
            }
        });
    });

    // Handle Delete Message
    $(document).on('click', '.delete-message-btn', function() {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to delete this message. This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
        var id = $(this).data('id');
        $.ajax({
            url: '/admin/messages/' + id,
            method: 'DELETE',
            success: function(resp) {
                location.reload();
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error deleting message: ' + (xhr.responseJSON?.errors || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
            }
        });
    });

    // Bootstrap tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // ===== BULK ACTIONS FUNCTIONALITY =====
    
    // Handle Select All checkbox
    $('#selectAll').on('change', function() {
        var isChecked = $(this).is(':checked');
        $('.message-checkbox').prop('checked', isChecked);
        updateBulkActionsVisibility();
    });
    
    // Handle individual checkbox changes
    $(document).on('change', '.message-checkbox', function() {
        var totalCheckboxes = $('.message-checkbox').length;
        var checkedCheckboxes = $('.message-checkbox:checked').length;
        
        // Update "Select All" checkbox state
        $('#selectAll').prop('checked', checkedCheckboxes === totalCheckboxes);
        $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
        
        updateBulkActionsVisibility();
    });
    
    // Update bulk actions dropdown visibility and count
    function updateBulkActionsVisibility() {
        var checkedCount = $('.message-checkbox:checked').length;
        $('#selectedCount').text(checkedCount);
        
        if (checkedCount > 0) {
            $('#bulkActionsDropdown').show();
        } else {
            $('#bulkActionsDropdown').hide();
        }
    }
    
    // Handle bulk delete
    $('#bulkDeleteBtn').on('click', function(e) {
        e.preventDefault();
        var selectedIds = [];
        $('.message-checkbox:checked').each(function() {
            selectedIds.push($(this).data('id'));
        });
        
        if (selectedIds.length === 0) {
            Swal.fire({
                title: 'No Messages Selected',
                text: 'Please select at least one message to delete.',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to delete ${selectedIds.length} message(s). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete them!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performBulkDelete(selectedIds);
            }
        });
    });
    
    // Perform bulk delete operation
    function performBulkDelete(ids) {
        $.ajax({
            url: '/admin/messages/bulk-delete',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: `${response.deleted_count} message(s) deleted successfully.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    $('#messages-table').DataTable().ajax.reload();
                    $('#selectAll').prop('checked', false);
                    updateBulkActionsVisibility();
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error deleting messages: ' + (xhr.responseJSON?.message || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }
    
    // Handle bulk mark as read
    $('#bulkMarkReadBtn').on('click', function(e) {
        e.preventDefault();
        var selectedIds = [];
        $('.message-checkbox:checked').each(function() {
            selectedIds.push($(this).data('id'));
        });
        
        if (selectedIds.length === 0) {
            Swal.fire({
                title: 'No Messages Selected',
                text: 'Please select at least one message to mark as read.',
                icon: 'warning',
                confirmButtonText: 'OK'
            });
            return;
        }
        
        Swal.fire({
            title: 'Mark as Read?',
            text: `Mark ${selectedIds.length} message(s) as read?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, mark as read!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performBulkMarkRead(selectedIds);
            }
        });
    });
    
    // Perform bulk mark as read operation
    function performBulkMarkRead(ids) {
        $.ajax({
            url: '/admin/messages/bulk-mark-read',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ ids: ids }),
            success: function(response) {
                Swal.fire({
                    title: 'Success!',
                    text: `${response.updated_count} message(s) marked as read.`,
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    $('#messages-table').DataTable().ajax.reload();
                    $('#selectAll').prop('checked', false);
                    updateBulkActionsVisibility();
                });
            },
            error: function(xhr) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Error marking messages as read: ' + (xhr.responseJSON?.message || xhr.responseText || 'Unknown error'),
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    }
    
    // Handle bulk archive (placeholder)
    $('#bulkArchiveBtn').on('click', function(e) {
        e.preventDefault();
        Swal.fire({
            title: 'Coming Soon',
            text: 'Bulk archive functionality will be available soon.',
            icon: 'info',
            confirmButtonText: 'OK'
        });
    });
    
    // Reset checkboxes when table reloads
    $('#messages-table').on('draw.dt', function() {
        $('#selectAll').prop('checked', false);
        updateBulkActionsVisibility();
    });
});
</script>
{% endblock %}
<!-- touch --> 