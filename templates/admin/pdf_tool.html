{% extends "admin/base.html" %}

{% block head_css %}
{{ super() }}

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
    .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 40px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
        margin-bottom: 20px;
        cursor: pointer;
    }
    .upload-area:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    .upload-area.dragover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    .upload-area.has-file {
        border-color: #28a745;
        background: #d4edda;
    }
    
    .pdf-preview-area {
        display: none;
        margin-top: 20px;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .pdf-preview-header {
        background: #f8f9fa;
        padding: 10px 15px;
        border-bottom: 1px solid #dee2e6;
        font-weight: bold;
        color: #495057;
    }
    
    .pdf-preview-wrapper {
        position: relative;
        background: #fff;
        min-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .pdf-preview {
        max-width: 100%;
        max-height: 100%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .page-navigation {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }
    
    .page-navigation .btn {
        padding: 5px 10px;
        font-size: 12px;
        min-width: auto;
    }
    
    .page-info {
        font-size: 14px;
        color: #6c757d;
        margin: 0 10px;
    }
    
    .options-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .signature-section {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 15px;
        display: none;
    }
    
    .signature-canvas {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        cursor: crosshair;
        margin-bottom: 15px;
    }
    
    .font-option {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        transition: background 0.2s ease;
        margin: 5px;
        display: inline-block;
    }
    .font-option:hover {
        background: #e9ecef;
    }
    .font-option.selected {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }
    
    .compression-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        display: none;
    }
    
    .disabled-option {
        opacity: 0.5;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">PDF Tool</h2>
    
    <form id="pdfForm" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-8">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drop your PDF file here</h5>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" style="display: none;">
                </div>
                
                <div id="fileInfo" style="display: none;">
                    <div class="alert alert-success">
                        <i class="fas fa-file-pdf me-2"></i>
                        <span id="fileName"></span>
                        <span id="fileSize" class="text-muted"></span>
                    </div>
                </div>
                
                <div id="pdfPreviewArea" class="pdf-preview-area">
                    <div class="pdf-preview-header">
                        <i class="fas fa-file-pdf me-2"></i>PDF Preview
                    </div>
                    
                    <div class="page-navigation">
                        <button type="button" class="btn btn-outline-secondary" id="prevPage">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="page-info">
                            Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                        </span>
                        <button type="button" class="btn btn-outline-secondary" id="nextPage">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="pdf-preview-wrapper">
                        <div id="pdfPreview" class="pdf-preview"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="options-panel">
                    <h5>Options</h5>
                    
                    <div class="mb-3">
                        <div id="compressOption" class="form-check disabled-option">
                            <input class="form-check-input" type="checkbox" id="compress" name="compress">
                            <label class="form-check-label" for="compress">Compress PDF</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div id="addSignatureOption" class="form-check disabled-option">
                            <input class="form-check-input" type="checkbox" id="add_signature" name="add_signature">
                            <label class="form-check-label" for="add_signature">Add Signature</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div id="digitalSignOption" class="form-check disabled-option">
                            <input class="form-check-input" type="checkbox" id="digital_sign" name="digital_sign">
                            <label class="form-check-label" for="digital_sign">Digital Certificate Sign</label>
                        </div>
                    </div>
                </div>
                
                <div id="signature-section" class="signature-section">
                    <h5>Signature Options</h5>
                    
                    <div class="mb-3">
                        <h6>Draw your signature</h6>
                        <canvas id="signatureCanvas" class="signature-canvas" width="300" height="150"></canvas>
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="button" id="clearSignature" class="btn btn-sm btn-danger">Clear</button>
                            <button type="button" id="undoSignature" class="btn btn-sm btn-warning">Undo</button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Type your name</h6>
                        <div class="font-selection mb-2">
                            <div class="font-option selected" data-font="Dancing Script">Dancing Script</div>
                            <div class="font-option" data-font="Great Vibes">Great Vibes</div>
                            <div class="font-option" data-font="Pacifico">Pacifico</div>
                            <div class="font-option" data-font="Satisfy">Satisfy</div>
                        </div>
                        <input type="text" id="typeSignature" class="form-control" placeholder="Type your name here...">
                        <div id="signaturePreview" class="mt-2 p-2 border rounded text-center" style="min-height: 40px;">
                            <span class="text-muted">Signature preview will appear here</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="signaturePage" class="form-label">Page:</label>
                        <select id="signaturePage" class="form-select">
                            <option value="1">Page 1</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="signaturePosition" class="form-label">Position:</label>
                        <select id="signaturePosition" class="form-select">
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="top-right">Top Right</option>
                            <option value="top-left">Top Left</option>
                            <option value="center">Center</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="signatureSize" class="form-label">Size:</label>
                        <input type="range" id="signatureSize" class="form-range" min="0.5" max="2" step="0.1" value="1">
                        <small class="text-muted">Scale: <span id="sizeValue">1.0</span>x</small>
                    </div>
                </div>
                
                <div id="compression-stats" class="compression-stats">
                    <h6>Compression Results</h6>
                    <div id="compression-details"></div>
                </div>
                
                <div class="text-center mt-4">
                    <button id="processBtn" class="btn btn-primary btn-lg" type="submit" disabled>
                        <i class="fas fa-cog"></i> Process PDF
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Global variables
let isDrawing = false;
let signatureData = [];
let signatureHistory = [];
let currentPath = [];
let typeSignatureData = { text: '', font: 'Dancing Script' };
let canvas, ctx;
let currentPage = 1;
let totalPages = 1;
let pdfDocument = null;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeCanvas();
    setupEventListeners();
    setupFontSelection();
});

function initializeCanvas() {
    canvas = document.getElementById('signatureCanvas');
    ctx = canvas.getContext('2d');
    
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    setupCanvasEvents();
}

function setupCanvasEvents() {
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mouseup', handleMouseUp);
    canvas.addEventListener('mouseout', handleMouseUp);
    
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
}

function handleMouseDown(e) {
    e.preventDefault();
    startDrawing(e.offsetX, e.offsetY);
}

function handleMouseMove(e) {
    e.preventDefault();
    if (isDrawing) {
        draw(e.offsetX, e.offsetY);
    }
}

function handleMouseUp(e) {
    e.preventDefault();
    stopDrawing();
}

function handleTouchStart(e) {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
}

function handleTouchMove(e) {
    e.preventDefault();
    if (isDrawing) {
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        draw(touch.clientX - rect.left, touch.clientY - rect.top);
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    stopDrawing();
}

function startDrawing(x, y) {
    isDrawing = true;
    currentPath = [{ x, y }];
    ctx.beginPath();
    ctx.moveTo(x, y);
}

function draw(x, y) {
    if (!isDrawing) return;
    currentPath.push({ x, y });
    ctx.lineTo(x, y);
    ctx.stroke();
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        if (currentPath.length > 0) {
            signatureData.push([...currentPath]);
            signatureHistory.push([...currentPath]);
        }
    }
}

function setupEventListeners() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('pdfFile');
    const form = document.getElementById('pdfForm');
    const addSignatureCheckbox = document.getElementById('add_signature');
    const signatureSection = document.getElementById('signature-section');
    const clearBtn = document.getElementById('clearSignature');
    const undoBtn = document.getElementById('undoSignature');
    const typeSignatureInput = document.getElementById('typeSignature');
    const signatureSize = document.getElementById('signatureSize');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');

    // File upload
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // Signature controls
    addSignatureCheckbox.addEventListener('change', () => {
        signatureSection.style.display = addSignatureCheckbox.checked ? 'block' : 'none';
        if (!addSignatureCheckbox.checked) {
            signatureData = [];
            signatureHistory = [];
            clearCanvas();
        }
    });

    clearBtn.addEventListener('click', clearCanvas);
    undoBtn.addEventListener('click', undoSignature);
    typeSignatureInput.addEventListener('input', updateTypeSignature);
    signatureSize.addEventListener('input', updateSignatureSize);
    prevPage.addEventListener('click', () => changePage(-1));
    nextPage.addEventListener('click', () => changePage(1));

    // Form submission
    form.addEventListener('submit', processForm);
}

function setupFontSelection() {
    const fontOptions = document.querySelectorAll('.font-option');
    fontOptions.forEach(option => {
        option.addEventListener('click', () => {
            fontOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            typeSignatureData.font = option.dataset.font;
            updateTypeSignature();
        });
    });
}

function handleFileSelect(file) {
    if (file.type !== 'application/pdf') {
        showMessage('Please select a PDF file.', 'error');
        return;
    }

    // Update UI
    const uploadArea = document.getElementById('uploadArea');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const processBtn = document.getElementById('processBtn');
    
    fileName.textContent = file.name;
    fileSize.textContent = ` (${formatFileSize(file.size)})`;
    
    uploadArea.style.display = 'none';
    fileInfo.style.display = 'block';
    
    // Enable options
    document.getElementById('compressOption').classList.remove('disabled-option');
    document.getElementById('addSignatureOption').classList.remove('disabled-option');
    document.getElementById('digitalSignOption').classList.remove('disabled-option');
    
    processBtn.disabled = false;
    
    // Load PDF preview
    loadPdfPreview(file);
}

function clearCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureData = [];
    signatureHistory = [];
}

function undoSignature() {
    if (signatureHistory.length > 0) {
        signatureHistory.pop();
        signatureData = [...signatureHistory];
        redrawCanvas();
    }
}

function redrawCanvas() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    signatureData.forEach(path => {
        if (path.length > 0) {
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            path.forEach(point => {
                ctx.lineTo(point.x, point.y);
            });
            ctx.stroke();
        }
    });
}

function updateTypeSignature() {
    const text = document.getElementById('typeSignature').value;
    typeSignatureData.text = text;
    showSignaturePreview();
}

function showSignaturePreview() {
    const preview = document.getElementById('signaturePreview');
    if (typeSignatureData.text) {
        preview.innerHTML = `<span style="font-family: '${typeSignatureData.font}', cursive; font-size: 24px;">${typeSignatureData.text}</span>`;
    } else {
        preview.innerHTML = '<span class="text-muted">Signature preview will appear here</span>';
    }
}

function updateSignatureSize() {
    const size = document.getElementById('signatureSize').value;
    document.getElementById('sizeValue').textContent = size;
}

function loadPdfPreview(file) {
    const pdfPreviewArea = document.getElementById('pdfPreviewArea');
    const fileInfo = document.getElementById('fileInfo');
    
    // Hide file info and show preview
    fileInfo.style.display = 'none';
    pdfPreviewArea.style.display = 'block';
    
    const fileReader = new FileReader();
    fileReader.onload = function() {
        const typedarray = new Uint8Array(this.result);
        
        pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
            pdfDocument = pdf;
            totalPages = pdf.numPages;
            currentPage = 1;
            
            updatePageNavigation();
            renderPage(1);
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            showMessage('Error loading PDF preview.', 'error');
        });
    };
    fileReader.readAsArrayBuffer(file);
}

function renderPage(pageNum) {
    if (!pdfDocument) return;
    
    pdfDocument.getPage(pageNum).then(function(page) {
        const viewport = page.getViewport({ scale: 1.0 });
        
        const container = document.getElementById('pdfPreview');
        const containerWidth = container.clientWidth - 40;
        const containerHeight = 500;
        
        const scaleX = containerWidth / viewport.width;
        const scaleY = containerHeight / viewport.height;
        const scale = Math.min(scaleX, scaleY, 1.5);
        
        const scaledViewport = page.getViewport({ scale: scale });
        
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = scaledViewport.height;
        canvas.width = scaledViewport.width;
        
        container.innerHTML = '';
        container.appendChild(canvas);
        
        const renderContext = {
            canvasContext: context,
            viewport: scaledViewport
        };
        
        page.render(renderContext).promise.then(function() {
            console.log(`Page ${pageNum} rendered successfully`);
        });
    }).catch(function(error) {
        console.error('Error rendering page:', error);
        showMessage('Error rendering PDF page.', 'error');
    });
}

function updatePageNavigation() {
    document.getElementById('currentPage').textContent = currentPage;
    document.getElementById('totalPages').textContent = totalPages;
    
    // Update signature page dropdown
    const signaturePage = document.getElementById('signaturePage');
    signaturePage.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Page ${i}`;
        signaturePage.appendChild(option);
    }
    
    // Update navigation buttons
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

function changePage(delta) {
    const newPage = currentPage + delta;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updatePageNavigation();
        renderPage(currentPage);
    }
}

function processForm(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('pdfFile');
    
    if (!fileInput.files[0]) {
        showMessage('Please select a PDF file.', 'error');
        return;
    }
    
    formData.append('pdf_file', fileInput.files[0]);
    
    // Add options
    if (document.getElementById('compress').checked) {
        formData.append('compress', '1');
    }
    if (document.getElementById('add_signature').checked) {
        formData.append('add_signature', '1');
        
        // Validate signature
        if (signatureData.length === 0 && !typeSignatureData.text) {
            showMessage('Please draw or type a signature.', 'error');
            return;
        }
        
        // Add signature data
        const signatureDataObj = {
            type: signatureData.length > 0 ? 'drawn' : 'typed',
            page: parseInt(document.getElementById('signaturePage').value),
            position: document.getElementById('signaturePosition').value,
            size: parseFloat(document.getElementById('signatureSize').value)
        };
        
        if (signatureData.length > 0) {
            signatureDataObj.paths = signatureData;
        } else {
            signatureDataObj.text = typeSignatureData.text;
            signatureDataObj.font = typeSignatureData.font;
        }
        
        formData.append('signature_data', JSON.stringify(signatureDataObj));
    }
    if (document.getElementById('digital_sign').checked) {
        formData.append('digital_sign', '1');
    }
    
    // Show loading state
    const processBtn = document.getElementById('processBtn');
    const originalText = processBtn.innerHTML;
    processBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    processBtn.disabled = true;
    
    // Submit form
    fetch('/admin/pdf-tool/process', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'processed_document.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        // Reset button
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
        
        // Show success message
        showMessage('PDF processed successfully!', 'success');
        
        // Show compression stats if available
        const compressionStats = response.headers.get('X-Compression-Stats');
        if (compressionStats) {
            try {
                const stats = JSON.parse(compressionStats);
                displayCompressionStats(stats);
            } catch (e) {
                console.error('Error parsing compression stats:', e);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('Error processing PDF. Please try again.', 'error');
        
        // Reset button
        processBtn.innerHTML = originalText;
        processBtn.disabled = false;
    });
}

function displayCompressionStats(stats) {
    const statsDiv = document.getElementById('compression-stats');
    const detailsDiv = document.getElementById('compression-details');
    
    detailsDiv.innerHTML = `
        <p><strong>Original Size:</strong> ${formatFileSize(stats.original_size)}</p>
        <p><strong>Compressed Size:</strong> ${formatFileSize(stats.compressed_size)}</p>
        <p><strong>Reduction:</strong> ${stats.reduction_percentage.toFixed(1)}%</p>
    `;
    
    statsDiv.style.display = 'block';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showMessage(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid');
    const existingAlert = container.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
