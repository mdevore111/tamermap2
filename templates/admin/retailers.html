{% extends 'admin/master.html' %}

{% block body %}
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <span data-bs-toggle="tooltip" title="All retailers in the system. Key columns shown in table, all fields available in edit modal.">Retailers</span>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addRetailerModal">Add Retailer</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm" id="retailers-table">
                            <thead>
                                <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>Machine Count</th>
                                                         <th>Active</th>
                            <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add Retailer Modal -->
            <div class="modal fade" id="addRetailerModal" tabindex="-1" aria-labelledby="addRetailerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form id="addRetailerForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addRetailerModalLabel">Add Retailer</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form fields will be injected by JS -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success">Add Retailer</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Edit Retailer Modal -->
            <div class="modal fade" id="editRetailerModal" tabindex="-1" aria-labelledby="editRetailerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form id="editRetailerForm">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editRetailerModalLabel">Edit Retailer</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Form fields will be injected by JS -->
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                  </form>
                </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (must be loaded before DataTables and custom JS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    const table = $('#retailers-table').DataTable({
        serverSide: true,
        processing: true,
        paging: true,
        searching: true,
        info: true,
        order: [[0, 'asc']],
        responsive: true,
        fixedHeader: false,
        scrollY: '400px',
        scrollCollapse: true,
        lengthMenu: [[25, 50, 100, 250, 500], [25, 50, 100, 250, 500]],
        pageLength: 25,
        language: { lengthMenu: 'Show _MENU_ entries per page' },
        ajax: {
            url: '/admin/retailers/data',
            type: 'GET'
        },
        columns: [
            { data: 'name' },
            { data: 'retailer_type' },
            { data: 'address' },
            { data: 'phone' },
            { data: 'machine_count' },
            { data: 'active' },
            { data: 'actions', orderable: false, searchable: false }
        ]
    });

    // Grey out disabled rows
    $('#retailers-table').on('draw.dt', function(){
        $('#retailers-table tbody tr').each(function(){
            const rowData = table.row(this).data();
            if (rowData && (rowData.active_value || '').toLowerCase() === 'false') {
                $(this).addClass('table-secondary');
                $(this).css('opacity', 0.65);
            } else {
                $(this).removeClass('table-secondary').css('opacity', 1);
            }
        });
    });

    // Add Retailer Modal: Render form fields
    $('#addRetailerModal').on('show.bs.modal', function() {
        var form = $(this).find('.modal-body');
        form.html(`
            <div class="row">
                <div class="col-md-6">
                    <div class='mb-3'><label class="form-label">Name *</label><input name='retailer' class='form-control' required></div>
                    <div class='mb-3'><label class="form-label">Type</label><input name='retailer_type' class='form-control' placeholder="e.g., Card Shop, Target, Walmart"></div>
                    <div class='mb-3'><label class="form-label">Full Address *</label><textarea name='full_address' class='form-control' rows="2" required></textarea></div>
                    <div class='mb-3'><label class="form-label">Phone Number</label><input name='phone_number' class='form-control' placeholder="(555) 123-4567"></div>
                    <div class='mb-3'><label class="form-label">Website</label><input name='website' class='form-control' type="url" placeholder="https://example.com"></div>
                </div>
                                    <div class="col-md-6">
                        <div class='mb-3'><label class="form-label">Machine Count</label><input name='machine_count' type='number' class='form-control' min="0" value="0"></div>
                                                   <div class='mb-3'><label class="form-label">Active</label><select name='enabled' class='form-select'>
                              <option value="true" selected>True</option>
                              <option value="false">False</option>
                          </select></div>
                         
                        <div class='mb-3'><label class="form-label">Rating</label><input name='rating' type='number' class='form-control' min="0" max="5" step="0.1" placeholder="0.0 - 5.0"></div>
                        <div class='mb-3'><label class="form-label">Place ID</label><input name='place_id' class='form-control' placeholder="Google Place ID"></div>
                    </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class='mb-3'><label class="form-label">Latitude</label><input name='latitude' type='number' class='form-control' step="any" placeholder="e.g., 40.7128"></div>
                </div>
                <div class="col-md-6">
                    <div class='mb-3'><label class="form-label">Longitude</label><input name='longitude' type='number' class='form-control' step="any" placeholder="e.g., -74.0060"></div>
                </div>
            </div>
            <div class='mb-3'><label class="form-label">Opening Hours</label><textarea name='opening_hours' class='form-control' rows="3" placeholder="Mon-Fri: 9AM-9PM, Sat-Sun: 10AM-8PM"></textarea></div>
        `);
    });

    // Handle Add Retailer submit
    $('#addRetailerForm').on('submit', function(e) {
        e.preventDefault();
        var data = {};
        $(this).find('input, textarea, select').each(function() {
            var value = $(this).val();
            var name = $(this).attr('name');
            
            if (value !== '') {
                // Handle boolean fields
                if (name === 'enabled') {
                    data[name] = value === 'true';
                } else {
                    data[name] = value;
                }
            }
        });
        
        $.ajax({
            url: '/admin/retailers/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                $('#addRetailerModal').modal('hide');
                $('#retailers-table').DataTable().ajax.reload();
                Swal.fire({
                    title: 'Success!',
                    text: 'Retailer added successfully!',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function(xhr) {
                var errorMsg = 'Error adding retailer';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseJSON && xhr.responseJSON.errors) {
                    errorMsg = JSON.stringify(xhr.responseJSON.errors);
                }
                alert(errorMsg);
            }
        });
    });

    // Edit Retailer Modal: Populate form fields using AJAX
    $(document).on('click', '.edit-retailer-btn', function() {
        var id = $(this).data('id');
        var modal = $('#editRetailerModal');
        var form = modal.find('.modal-body');
        
        $.get('/admin/retailers/' + id, function(data) {
            var firstSeenDate = data.first_seen ? new Date(data.first_seen).toLocaleString() : 'N/A';
            var lastUpdateDate = data.last_api_update ? new Date(data.last_api_update).toLocaleString() : 'N/A';
            
            form.html(`
                <input type='hidden' name='id' value='${data.id}'>
                <div class="alert alert-info">
                    <strong>ID:</strong> ${data.id} | 
                    <strong>First Seen:</strong> ${firstSeenDate} | 
                    <strong>Last Updated:</strong> ${lastUpdateDate}
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class='mb-3'><label class="form-label">Name *</label><input name='retailer' class='form-control' value='${data.retailer || ''}' required></div>
                        <div class='mb-3'><label class="form-label">Type</label><input name='retailer_type' class='form-control' value='${data.retailer_type || ''}' placeholder="e.g., Card Shop, Target, Walmart"></div>
                        <div class='mb-3'><label class="form-label">Full Address *</label><textarea name='full_address' class='form-control' rows="2" required>${data.full_address || ''}</textarea></div>
                        <div class='mb-3'><label class="form-label">Phone Number</label><input name='phone_number' class='form-control' value='${data.phone_number || ''}' placeholder="(555) 123-4567"></div>
                        <div class='mb-3'><label class="form-label">Website</label><input name='website' class='form-control' type="url" value='${data.website || ''}' placeholder="https://example.com"></div>
                    </div>
                    <div class="col-md-6">
                        <div class='mb-3'><label class="form-label">Machine Count</label><input name='machine_count' type='number' class='form-control' min="0" value='${data.machine_count || 0}'></div>
                        <div class='mb-3'><label class="form-label">Previous Count</label><input name='previous_count' type='number' class='form-control' min="0" value='${data.previous_count || 0}' readonly></div>
                                                  <div class='mb-3'><label class="form-label">Active</label><select name='enabled' class='form-select'>
                             <option value="true" ${data.enabled === true ? 'selected' : ''}>True</option>
                             <option value="false" ${data.enabled === false ? 'selected' : ''}>False</option>
                         </select></div>
                         
                        <div class='mb-3'><label class="form-label">Rating</label><input name='rating' type='number' class='form-control' min="0" max="5" step="0.1" value='${data.rating || ''}' placeholder="0.0 - 5.0"></div>
                        <div class='mb-3'><label class="form-label">Place ID</label><input name='place_id' class='form-control' value='${data.place_id || ''}' placeholder="Google Place ID"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class='mb-3'><label class="form-label">Latitude</label><input name='latitude' type='number' class='form-control' step="any" value='${data.latitude || ''}' placeholder="e.g., 40.7128"></div>
                    </div>
                    <div class="col-md-6">
                        <div class='mb-3'><label class="form-label">Longitude</label><input name='longitude' type='number' class='form-control' step="any" value='${data.longitude || ''}' placeholder="e.g., -74.0060"></div>
                    </div>
                </div>
                <div class='mb-3'><label class="form-label">Opening Hours</label><textarea name='opening_hours' class='form-control' rows="3" placeholder="Mon-Fri: 9AM-9PM, Sat-Sun: 10AM-8PM">${data.opening_hours || ''}</textarea></div>
            `);
            modal.modal('show');
        }).fail(function() {
            Swal.fire({
                title: 'Error!',
                text: 'Error loading retailer data. Please try again.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    });

    // Handle inline status change with confirmation
    $(document).on('change', '.retailer-status-select', function(){
        const id = $(this).data('id');
        const newStatus = $(this).val();
        const self = this;
        Swal.fire({
          title: 'Change Active Status?',
          text: 'Do you want to change whether this retailer is active?',
          icon: 'question',
          showCancelButton: true
        }).then(res => {
          if (res.isConfirmed) {
            fetch('/admin/retailers/' + id, {
              method: 'PUT', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled: newStatus === 'True' })
            }).then(r => {
              if (!r.ok) throw new Error('Failed');
              // Update the data-current attribute to reflect the new state
              $(self).data('current', newStatus);
              // Reload the table to show updated data
              $('#retailers-table').DataTable().ajax.reload(null, false);
            }).catch(() => {
              Swal.fire({ icon: 'error', title: 'Failed to update active status' });
              // revert UI
              $(self).val($(self).data('current'));
            });
          } else {
            // revert UI
            $(self).val($(self).data('current'));
          }
        });
    });

    // Handle Edit Retailer submit
    $('#editRetailerForm').on('submit', function(e) {
        e.preventDefault();
        var id = $(this).find('input[name="id"]').val();
        var data = {};
        
        $(this).find('input, textarea, select').each(function() {
            if ($(this).attr('name') !== 'id' && $(this).attr('name') !== 'previous_count') {
                var value = $(this).val();
                var name = $(this).attr('name');
                
                if (value !== '') {
                    // Handle boolean fields
                    if (name === 'enabled') {
                        data[name] = value === 'true';
                    } else {
                        data[name] = value;
                    }
                }
            }
        });
        
        $.ajax({
            url: '/admin/retailers/edit/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                $('#editRetailerModal').modal('hide');
                $('#retailers-table').DataTable().ajax.reload();
                Swal.fire({
                    title: 'Success!',
                    text: 'Retailer updated successfully!',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function(xhr) {
                var errorMsg = 'Error updating retailer';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseJSON && xhr.responseJSON.errors) {
                    errorMsg = JSON.stringify(xhr.responseJSON.errors);
                }
                alert(errorMsg);
            }
        });
    });

    // Handle Delete Retailer
    $(document).on('click', '.delete-retailer-btn', function() {
        var id = $(this).data('id');
        var name = $(this).data('name') || 'this retailer';
        
        Swal.fire({
            title: 'Are you sure?',
            text: 'You are about to delete this retailer. This action cannot be undone!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
        $.ajax({
                    url: '/admin/retailers/' + id,
            method: 'DELETE',
            success: function(resp) {
                        $('#retailers-table').DataTable().ajax.reload();
                        Swal.fire({
                            title: 'Deleted!',
                            text: 'Retailer "' + name + '" deleted successfully!',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
            },
            error: function(xhr) {
                        var errorMsg = 'Error deleting retailer';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseJSON && xhr.responseJSON.errors) {
                            errorMsg = JSON.stringify(xhr.responseJSON.errors);
                        }
                        alert(errorMsg);
                    }
                });
            }
        });
    });

    // Bootstrap tooltip initialization
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}
<!-- touch --> 