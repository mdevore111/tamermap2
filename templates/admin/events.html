{% extends 'admin/master.html' %}

{% block body %}
<div class="container-fluid">
    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Event Filter</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="futureEventsToggle">
                            <label class="form-check-label" for="futureEventsToggle">
                                Show Future Events Only
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Events Dashboard Cards -->
    <div class="row mb-4" id="eventsDashboard">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Events
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="count-total">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-secondary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-secondary text-uppercase mb-1">
                                Past Events
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="count-past">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Next 30 Days
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="count-0-30">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                31-60 Days
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="count-31-60">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-week fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Events Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <div>
                <span data-bs-toggle="tooltip" title="All events in the system. Columns include name, date, location, description, and actions to edit or delete." id="tableTitle">Events</span>
                <small class="text-muted d-block">All dates and times shown in UTC (server time)</small>
            </div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEventModal">Add Event</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm" id="events-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Address</th>
                            <th>Start Date <small class="text-muted">(UTC)</small></th>
                            <th>Start Time <small class="text-muted">(UTC)</small></th>
                            <th>End Date <small class="text-muted">(UTC)</small></th>
                            <th>End Time <small class="text-muted">(UTC)</small></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="addEventForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addEventModalLabel">Add Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form fields will be injected by JS or rendered here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Event</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editEventForm">
        <div class="modal-header">
          <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form fields will be injected by JS or rendered here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- jQuery (must be loaded before DataTables and custom JS) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
$(document).ready(function() {
    let eventsTable;
    let isFutureEventsMode = false;

    // Initialize DataTable
    function initializeDataTable() {
        if (eventsTable) {
            eventsTable.destroy();
        }

        const columns = [
            { data: 'event_title' },
            { data: 'full_address' },
            { data: 'start_date' },
            { data: 'start_time' },
            { data: 'end_date' },
            { data: 'end_time' },
            { data: 'actions', orderable: false, searchable: false }
        ];

        eventsTable = $('#events-table').DataTable({
            serverSide: true,
            processing: true,
            paging: true,
            searching: true,
            info: true,
            order: [],
            responsive: true,
            fixedHeader: false,
            scrollY: '400px',
            scrollCollapse: true,
            lengthMenu: [[25, 50, 100, 250, 500], [25, 50, 100, 250, 500]],
            pageLength: 25,
            language: { lengthMenu: 'Show _MENU_ entries per page' },
            ajax: {
                url: '/admin/events/data',
                type: 'GET',
                data: function(d) {
                    d.future_only = isFutureEventsMode;
                }
            },
            columns: columns,

        });
    }

    // Initialize the table
    initializeDataTable();

    // Handle filter toggle
    $('#futureEventsToggle').on('change', function() {
        isFutureEventsMode = $(this).is(':checked');
        
        // Update table title
        if (isFutureEventsMode) {
            $('#tableTitle').text('Future Events');
        } else {
            $('#tableTitle').text('Events');
        }
        
        // Always load stats and reinitialize table
        loadEventsStats();
        initializeDataTable();
    });

    // Load events statistics
    function loadEventsStats() {
        $.get('/admin/events/stats', function(data) {
            $('#count-total').text(data['total']);
            $('#count-past').text(data['past']);
            $('#count-0-30').text(data['0_30']);
            $('#count-31-60').text(data['31_60']);
        }).fail(function() {
            console.error('Failed to load events statistics');
        });
    }

    // Load stats on page load
    loadEventsStats();

    // Add Event Modal: Render form fields
    $('#addEventModal').on('show.bs.modal', function() {
        var form = $(this).find('.modal-body');
        form.html(`
            <div class='mb-3'><label>Title</label><input name='event_title' class='form-control' required></div>
            <div class='mb-3'><label>Address</label><input name='full_address' class='form-control' required></div>
            <div class='mb-3'><label>Start Date</label><input name='start_date' type='date' class='form-control'></div>
            <div class='mb-3'><label>Start Time</label><input name='start_time' type='time' class='form-control'></div>
            <div class='mb-3'><label>End Date</label><input name='end_date' type='date' class='form-control'></div>
            <div class='mb-3'><label>End Time</label><input name='end_time' type='time' class='form-control'></div>
            <div class='mb-3'><label>Registration URL</label><input name='registration_url' class='form-control'></div>
            <div class='mb-3'><label>Price</label><input name='price' type='number' step='0.01' class='form-control'></div>
            <div class='mb-3'><label>Email</label><input name='email' type='email' class='form-control'></div>
            <div class='mb-3'><label>Phone</label><input name='phone' class='form-control'></div>
        `);
    });

    // Handle Add Event submit
    $('#addEventForm').on('submit', function(e) {
        e.preventDefault();
        var data = {};
        $(this).find('input').each(function() {
            var value = $(this).val();
            // Convert empty strings to null for optional fields
            if (value === '' && ['end_date', 'end_time', 'registration_url', 'price', 'email', 'phone'].includes($(this).attr('name'))) {
                data[$(this).attr('name')] = null;
            } else {
                data[$(this).attr('name')] = value;
            }
        });
        
        $.ajax({
            url: '/admin/events/add',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                $('#addEventModal').modal('hide');
                eventsTable.ajax.reload();
                loadEventsStats();
                Swal.fire({
                    title: 'Success!',
                    text: 'Event added successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function(xhr) {
                console.error('Error adding event:', xhr);
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.error || xhr.responseJSON?.message || 'Unknown error',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    });

    // Edit Event Modal: Populate form fields using AJAX
    $(document).on('click', '.edit-event-btn', function() {
        var id = $(this).data('id');
        var modal = $('#editEventModal');
        var form = modal.find('.modal-body');
        $.get('/admin/events/' + id, function(data) {
            form.html(`
                <input type='hidden' name='id' value='${data.id}'>
                <div class='mb-3'><label>Title</label><input name='event_title' class='form-control' value='${data.event_title || ''}' required></div>
                <div class='mb-3'><label>Address</label><input name='full_address' class='form-control' value='${data.full_address || ''}' required></div>
                <div class='mb-3'><label>Start Date</label><input name='start_date' type='date' class='form-control' value='${data.start_date || ''}'></div>
                <div class='mb-3'><label>Start Time</label><input name='start_time' type='time' class='form-control' value='${data.start_time || ''}'></div>
                <div class='mb-3'><label>End Date</label><input name='end_date' type='date' class='form-control' value='${data.end_date || ''}'></div>
                <div class='mb-3'><label>End Time</label><input name='end_time' type='time' class='form-control' value='${data.end_time || ''}'></div>
                <div class='mb-3'><label>Registration URL</label><input name='registration_url' class='form-control' value='${data.registration_url || ''}'></div>
                <div class='mb-3'><label>Price</label><input name='price' type='number' step='0.01' class='form-control' value='${data.price || ''}'></div>
                <div class='mb-3'><label>Email</label><input name='email' type='email' class='form-control' value='${data.email || ''}'></div>
                <div class='mb-3'><label>Phone</label><input name='phone' class='form-control' value='${data.phone || ''}'></div>
            `);
            modal.modal('show');
        }).fail(function() {
            Swal.fire({
                title: 'Error!',
                text: 'Error loading event data.',
                icon: 'error',
                confirmButtonText: 'OK'
            });
        });
    });

    // Handle Edit Event submit
    $('#editEventForm').on('submit', function(e) {
        e.preventDefault();
        var id = $(this).find('input[name="id"]').val();
        var data = {};
        $(this).find('input').each(function() {
            if ($(this).attr('name') !== 'id') {
                var value = $(this).val();
                // Convert empty strings to null for optional fields
                if (value === '' && ['end_date', 'end_time', 'registration_url', 'price', 'email', 'phone'].includes($(this).attr('name'))) {
                    data[$(this).attr('name')] = null;
                } else {
                    data[$(this).attr('name')] = value;
                }
            }
        });
        
        $.ajax({
            url: '/admin/events/edit/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(resp) {
                $('#editEventModal').modal('hide');
                eventsTable.ajax.reload();
                loadEventsStats();
                Swal.fire({
                    title: 'Success!',
                    text: 'Event updated successfully',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
            },
            error: function(xhr) {
                console.error('Error updating event:', xhr);
                Swal.fire({
                    title: 'Error!',
                    text: xhr.responseJSON?.error || xhr.responseJSON?.message || 'Unknown error',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        });
    });

    // Handle Delete Event
    $(document).on('click', '.delete-event-btn', function() {
        var id = $(this).data('id');
        var name = $(this).data('name');
        
        Swal.fire({
            title: 'Are you sure?',
            text: `Do you want to delete "${name}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/admin/events/' + id,
                    method: 'DELETE',
                    success: function(resp) {
                        eventsTable.ajax.reload();
                        loadEventsStats();
                        Swal.fire(
                            'Deleted!',
                            'Event has been deleted.',
                            'success'
                        );
                    },
                    error: function(xhr) {
                        console.error('Error deleting event:', xhr);
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to delete event.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                });
            }
        });
    });
});
</script>
{% endblock %} 